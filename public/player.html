<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Reproductor Flechazo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS (Idénticos al anterior pero optimizados) --- */
        html, body {
            margin: 0; padding: 0; background: #000; color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100dvh; width: 100vw; overflow: hidden;
            position: fixed; top: 0; left: 0;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .video-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #000;
        }
        
        /* El video HTML5 y el contenedor de YouTube */
        video, #yt-placeholder { 
            width: 100%; height: 100%; object-fit: contain; 
            position: absolute; top:0; left:0;
        }
        /* Clase para ocultar lo que no se usa */
        .hidden { visibility: hidden; opacity: 0; pointer-events: none; z-index: -1; }

        /* Capa táctil transparente (encima del video) */
        .center-touch-area {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* Icono Play/Pause Animado */
        .play-icon-anim {
            font-size: 5rem; color: rgba(255,255,255,0.8);
            filter: drop-shadow(0 0 10px black);
            opacity: 0; transform: scale(1.5); transition: all 0.2s; pointer-events: none;
        }
        .paused .play-icon-anim { opacity: 1; transform: scale(1); }

        /* Spinner */
        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #ff3366;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
            position: absolute; z-index: 5; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Marca de Agua */
        .watermark {
            position: absolute; top: 20px; right: 20px; z-index: 20; opacity: 0.5; pointer-events: none;
            display: flex; align-items: center; gap: 8px;
        }
        .wm-logo { font-size: 1.2rem; color: #ff3366; }
        .wm-text { font-weight: 800; font-size: 0.7rem; color: rgba(255,255,255,0.7); }

        /* UI Layer */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 30;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .top-bar {
            padding: max(15px, env(safe-area-inset-top)) 20px;
            display: flex; align-items: center; gap: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            pointer-events: auto;
        }
        .back-icon { font-size: 1.5rem; padding: 10px; cursor: pointer; }
        .video-title { font-weight: 700; font-size: 1rem; }
        .video-subtitle { font-size: 0.8rem; color: #ccc; }

        .progress-container {
            width: 100%; height: 20px; 
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            display: flex; align-items: flex-end;
            pointer-events: auto; cursor: pointer;
        }
        .progress-track { width: 100%; height: 3px; background: rgba(255,255,255,0.3); position: relative; }
        .progress-fill { height: 100%; width: 0%; background: #ff3366; position: relative; }
        .progress-fill::after {
            content: ''; position: absolute; right: -6px; top: -4px; width: 10px; height: 10px; 
            background: white; border-radius: 50%; transform: scale(0); transition: transform 0.2s;
        }
        .progress-container:active .progress-track { height: 6px; }
        .progress-container:active .progress-fill::after { transform: scale(1.5); }

        /* Animación Seek */
        .seek-anim {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 50%;
            color: white; font-size: 1.5rem; opacity: 0; pointer-events: none; z-index: 15;
        }
        .seek-left { left: 20%; } .seek-right { right: 20%; }
        .show-seek { animation: fadePop 0.6s ease-out; }
        @keyframes fadePop { 0% { opacity: 0; transform: translateY(-50%) scale(0.8); } 50% { opacity: 1; transform: translateY(-50%) scale(1.1); } 100% { opacity: 0; transform: translateY(-50%) scale(1); } }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body oncontextmenu="return false;">

    <div class="video-container">
        <video id="html5-player" class="hidden" playsinline></video>
        
        <div id="yt-placeholder"></div>

        <div id="spinner" class="loading-spinner"></div>

        <div id="touchArea" class="center-touch-area" onclick="handleMainClick(event)">
            <i class="fa-solid fa-play play-icon-anim"></i>
        </div>

        <div id="seekLeft" class="seek-anim seek-left"><i class="fa-solid fa-backward"></i> -10s</div>
        <div id="seekRight" class="seek-anim seek-right"><i class="fa-solid fa-forward"></i> +10s</div>

        <div class="watermark">
            <i class="fa-solid fa-heart wm-logo"></i><span class="wm-text">FLECHAZO TV</span>
        </div>

        <div class="ui-layer">
            <div class="top-bar">
                <i class="fa-solid fa-arrow-left back-icon" onclick="history.back()"></i>
                <div class="video-info">
                    <div id="ui-title" class="video-title">Cargando...</div>
                    <div id="ui-subtitle" class="video-subtitle">Espere un momento</div>
                </div>
            </div>
            
            <div class="progress-container" onclick="handleSeek(event)">
                <div class="progress-track"><div id="prog-fill" class="progress-fill"></div></div>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let playerType = 'none'; // 'youtube' | 'html5'
        let ytPlayer = null;
        let html5Player = document.getElementById('html5-player');
        let isPlaying = false;
        let progressInterval = null;
        
        // --- DATOS DE PRUEBA (Aquí pones tu lógica de API real) ---
        const itemData = {
            title: "El Gran Maestro",
            subtitle: "Episodio 1",
            // PRUEBA AQUÍ: Cambia esto por un .mp4 para probar el otro modo
            url: "https://youtu.be/eEh6mqsXZyk" 
        };

        // --- INICIO ---
        window.onload = () => {
            document.getElementById('ui-title').innerText = itemData.title;
            document.getElementById('ui-subtitle').innerText = itemData.subtitle;
            loadVideo(itemData.url);
        };

        function loadVideo(url) {
            const spinner = document.getElementById('spinner');
            spinner.style.display = 'block';

            // 1. Detectar YouTube
            const ytId = getYouTubeId(url);
            
            if (ytId) {
                playerType = 'youtube';
                html5Player.classList.add('hidden');
                initYouTubePlayer(ytId);
            } else {
                playerType = 'html5';
                if(ytPlayer) ytPlayer.destroy(); // Limpiar YT si existía
                document.getElementById('yt-placeholder').classList.add('hidden');
                html5Player.classList.remove('hidden');
                
                html5Player.src = url;
                html5Player.load();
                // Eventos HTML5
                html5Player.oncanplay = () => spinner.style.display = 'none';
                html5Player.onwaiting = () => spinner.style.display = 'block';
                html5Player.onplaying = () => { spinner.style.display = 'none'; updatePlayState(true); };
                html5Player.onpause = () => updatePlayState(false);
                html5Player.ontimeupdate = updateProgressHTML5;
            }
        }

        // --- LÓGICA YOUTUBE API ---
        function getYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function initYouTubePlayer(videoId) {
            // Si la API de YT aún no cargó, esperamos
            if (!window.YT || !window.YT.Player) {
                setTimeout(() => initYouTubePlayer(videoId), 100);
                return;
            }

            ytPlayer = new YT.Player('yt-placeholder', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,       // Intentar autoplay
                    'controls': 0,       // OCULTAR controles nativos (Clave para tu diseño)
                    'rel': 0,            // Sin relacionados
                    'modestbranding': 1,
                    'playsinline': 1     // Importante para iPhone
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
            document.getElementById('yt-placeholder').classList.remove('hidden');
        }

        function onPlayerReady(event) {
            document.getElementById('spinner').style.display = 'none';
            event.target.playVideo(); // Intentar reproducir
            startProgressLoop();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                document.getElementById('spinner').style.display = 'none';
                updatePlayState(true);
            } else if (event.data == YT.PlayerState.PAUSED) {
                updatePlayState(false);
            } else if (event.data == YT.PlayerState.BUFFERING) {
                document.getElementById('spinner').style.display = 'block';
            }
        }

        // --- CONTROLES UNIFICADOS (CLICK PANTALLA) ---
        let lastClick = 0;
        function handleMainClick(e) {
            const now = new Date().getTime();
            const width = window.innerWidth;
            const x = e.clientX;

            // Doble Tap Logic
            if (now - lastClick < 300) {
                if (x < width / 3) { seek(-10); animSeek('seekLeft'); }
                else if (x > (width / 3) * 2) { seek(10); animSeek('seekRight'); }
                else { togglePlay(); }
            } else {
                // Single Tap (con delay para esperar al doble tap)
                setTimeout(() => {
                    if (new Date().getTime() - lastClick > 300) togglePlay();
                }, 350);
            }
            lastClick = now;
        }

        function togglePlay() {
            if (playerType === 'youtube' && ytPlayer && ytPlayer.playVideo) {
                // Nota: getState 1 es Playing, 2 es Paused
                const state = ytPlayer.getPlayerState();
                if (state === 1) ytPlayer.pauseVideo();
                else ytPlayer.playVideo();
            } else if (playerType === 'html5') {
                if (html5Player.paused) html5Player.play();
                else html5Player.pause();
            }
        }

        function updatePlayState(playing) {
            isPlaying = playing;
            const touchArea = document.getElementById('touchArea');
            if (playing) touchArea.classList.remove('paused');
            else touchArea.classList.add('paused');
        }

        // --- SEEK & PROGRESO ---
        function seek(seconds) {
            if (playerType === 'youtube' && ytPlayer) {
                const current = ytPlayer.getCurrentTime();
                ytPlayer.seekTo(current + seconds, true);
            } else if (playerType === 'html5') {
                html5Player.currentTime += seconds;
            }
        }

        function handleSeek(e) {
            e.stopPropagation(); // Evitar que dispare el play/pause del fondo
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            
            if (playerType === 'youtube' && ytPlayer) {
                const duration = ytPlayer.getDuration();
                ytPlayer.seekTo(duration * pct, true);
            } else {
                const duration = html5Player.duration;
                html5Player.currentTime = duration * pct;
            }
        }

        function animSeek(id) {
            const el = document.getElementById(id);
            el.classList.add('show-seek');
            setTimeout(() => el.classList.remove('show-seek'), 600);
        }

        // --- BUCLE DE PROGRESO (Para YouTube) ---
        function startProgressLoop() {
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                if (playerType === 'youtube' && ytPlayer && ytPlayer.getCurrentTime) {
                    const current = ytPlayer.getCurrentTime();
                    const duration = ytPlayer.getDuration();
                    if(duration > 0) updateProgressBar((current / duration) * 100);
                }
            }, 500);
        }

        function updateProgressHTML5() {
            if (html5Player.duration) {
                updateProgressBar((html5Player.currentTime / html5Player.duration) * 100);
            }
        }

        function updateProgressBar(percent) {
            document.getElementById('prog-fill').style.width = percent + '%';
        }

    </script>
</body>
</html>
