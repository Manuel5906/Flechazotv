<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Flechazo Player PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <style>
        /* --- CORE --- */
        html, body {
            margin: 0; padding: 0; background: #000; color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100dvh; width: 100vw; overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .video-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; align-items: center; justify-content: center;
            cursor: default;
        }
        
        /* Ocultar cursor */
        .video-container.hide-cursor { cursor: none; }

        video, #yt-placeholder { width: 100%; height: 100%; object-fit: contain; position: absolute; z-index: 0; }
        .hidden { opacity: 0; pointer-events: none; }

        /* --- CAPAS Y GESTOS --- */
        #brightness-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; opacity: 0; pointer-events: none; z-index: 10;
            transition: opacity 0.1s;
        }

        #gestureLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; touch-action: none; 
        }

        /* Feedback Central */
        .center-feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.6); padding: 25px; border-radius: 20px;
            text-align: center; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 60;
            backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; min-width: 100px;
        }
        .center-feedback.visible { opacity: 1; }
        .feedback-icon { font-size: 2.5rem; color: #ff3366; margin-bottom: 10px; }
        .feedback-text { font-size: 1.2rem; font-weight: 800; }

        /* --- UI LAYER --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: flex; flex-direction: column; justify-content: space-between;
            transition: opacity 0.4s ease-in-out;
            pointer-events: none;
        }
        
        .ui-layer.hidden-ui { opacity: 0; }
        .ui-layer > * { pointer-events: auto; }

        /* Top Bar */
        .top-bar {
            padding: max(15px, env(safe-area-inset-top)) 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 60%, transparent 100%);
            display: flex; align-items: center; gap: 15px;
        }
        .video-info { flex: 1; overflow: hidden; }
        .video-title { font-weight: 700; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .video-subtitle { font-size: 0.8rem; color: #ccc; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        
        .system-info {
            display: flex; align-items: center; gap: 10px; font-size: 0.8rem; 
            color: #ddd; background: rgba(0,0,0,0.4); padding: 5px 10px; border-radius: 15px;
            backdrop-filter: blur(4px);
        }
        .battery-icon { font-size: 0.9rem; color: #0f0; }

        .top-icons { display: flex; gap: 20px; font-size: 1.3rem; margin-left: 10px; }
        .icon-btn { cursor: pointer; filter: drop-shadow(0 2px 2px black); transition: color 0.2s, transform 0.1s; }
        .icon-btn:active { color: #ff3366; transform: scale(0.9); }

        /* Botón Saltar Intro */
        .skip-intro {
            position: absolute; bottom: 100px; left: 20px;
            background: white; color: black; padding: 8px 16px; border-radius: 4px;
            font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; gap: 8px;
            cursor: pointer; opacity: 0; transform: translateY(20px); pointer-events: none;
            transition: all 0.4s ease; z-index: 55; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .skip-intro.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

        /* Sidebar Derecha */
        .sidebar {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 25px; align-items: center;
        }
        .side-circle {
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(30, 30, 30, 0.6); border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center; color: white;
            cursor: pointer; backdrop-filter: blur(4px); font-size: 1.1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* Botón Desbloquear */
        #unlockBtn {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 51, 102, 0.9); padding: 10px 25px; border-radius: 30px;
            display: flex; align-items: center; gap: 10px; font-weight: bold;
            z-index: 99; cursor: pointer; display: none; box-shadow: 0 0 15px rgba(255, 51, 102, 0.4);
        }

        /* Controles Inferiores */
        .bottom-area {
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 60%, transparent 100%);
            padding: 0 20px max(20px, env(safe-area-inset-bottom));
        }
        .progress-container { width: 100%; height: 30px; display: flex; align-items: center; cursor: pointer; position: relative; }
        
        .progress-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: absolute; width: 100%; }
        .progress-buffer { width: 0%; height: 4px; background: rgba(255,255,255,0.5); border-radius: 2px; position: absolute; left: 0; transition: width 0.2s; }
        .progress-fill { height: 4px; width: 0%; background: #ff3366; border-radius: 2px; position: absolute; left: 0; z-index: 2; }
        
        .progress-fill::after { 
            content: ''; position: absolute; right: -6px; top: -4px; width: 12px; height: 12px; 
            background: white; border-radius: 50%; transform: scale(0); transition: transform 0.2s; box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .ui-layer:not(.hidden-ui) .progress-fill::after { transform: scale(1); }

        /* Layout Fila Inferior */
        .controls-row { 
            display: flex; justify-content: space-between; align-items: center; margin-top: 5px; 
        }
        
        /* Grupo Izquierdo (Play + Tiempo) */
        .left-controls { display: flex; align-items: center; gap: 20px; }

        .time-text { font-family: monospace; font-size: 0.85rem; font-weight: 600; color: #ddd; text-shadow: 0 1px 2px black; }

        /* --- DRAWERS --- */
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 70; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .drawer-overlay.open { opacity: 1; pointer-events: auto; }
        
        .drawer { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a;
            border-radius: 20px 20px 0 0; z-index: 75; transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); padding-bottom: max(20px, env(safe-area-inset-bottom));
            max-height: 70vh; display: flex; flex-direction: column;
        }
        .drawer.open { transform: translateY(0); }
        .drawer-header { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        
        .speed-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px; }
        .speed-btn { background: #333; padding: 12px; border-radius: 12px; text-align: center; font-size: 0.9rem; font-weight: 600; }
        .speed-btn.active { background: #ff3366; color: white; }

        .ep-list { overflow-y: auto; padding: 10px 20px; }
        .ep-item { padding: 15px; margin-bottom: 8px; border-radius: 10px; background: #252525; display: flex; gap: 15px; cursor: pointer; }
        .ep-item.active { border: 1px solid #ff3366; background: #2a1a1a; }
        .ep-num { color: #ff3366; font-weight: bold; }

        /* Seek Anim */
        .seek-badge {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 50%;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 40; font-size: 1.2rem;
        }
        .seek-badge.visible { opacity: 1; animation: pop 0.4s; }
        @keyframes pop { 50% { transform: translateY(-50%) scale(1.2); } }

        /* Spinner */
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: #ff3366; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; position: absolute; z-index: 5; display: none; pointer-events: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .center-play-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5rem; color: rgba(255,255,255,0.7); pointer-events: none; opacity: 0; transition: transform 0.2s, opacity 0.2s; z-index: 30;
        }
        .show-play .center-play-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; cursor: pointer; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="brightness-overlay"></div>

    <div class="video-container" id="mainContainer" onmousemove="resetUiTimer()">
        <video id="html5-player" class="hidden" playsinline></video>
        <div id="yt-placeholder"></div>
        <div id="spinner" class="spinner"></div>

        <div id="centerFeedback" class="center-feedback">
            <i id="feedIcon" class="fa-solid fa-volume-high feedback-icon"></i>
            <div id="feedText" class="feedback-text">100%</div>
        </div>
        
        <div id="bigPlay" class="center-play-icon" onclick="togglePlay()"><i class="fa-solid fa-play"></i></div>

        <div id="seekLeft" class="seek-badge" style="left: 20%;"><i class="fa-solid fa-backward"></i> 10s</div>
        <div id="seekRight" class="seek-badge" style="right: 20%;"><i class="fa-solid fa-forward"></i> 10s</div>

        <div id="gestureLayer"></div>

        <div id="unlockBtn" onclick="toggleLock()">
            <i class="fa-solid fa-lock-open"></i> DESBLOQUEAR
        </div>

        <div id="uiLayer" class="ui-layer">
            <div class="top-bar">
                <i class="fa-solid fa-arrow-left icon-btn" onclick="goBack()" style="font-size:1.4rem;"></i>
                <div class="video-info">
                    <div id="ui-title" class="video-title">Cargando...</div>
                    <div id="ui-subtitle" class="video-subtitle">Flechazo TV</div>
                </div>
                
                <div class="system-info">
                    <span id="sysTime">12:00</span>
                    <i id="battIcon" class="fa-solid fa-battery-full battery-icon"></i>
                </div>

                <div class="top-icons">
                    <i class="fa-solid fa-gauge-high icon-btn" onclick="toggleDrawer('speed')"></i>
                    <i class="fa-solid fa-lock icon-btn" onclick="toggleLock()"></i>
                </div>
            </div>

            <div class="sidebar">
                <div class="side-circle" onclick="toggleDrawer('eps')" id="btnEpList" style="display:none;">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div class="side-circle" onclick="nextEp()" id="btnNext" style="display:none; transform: scale(0); transition: transform 0.3s;">
                    <i class="fa-solid fa-forward-step"></i>
                </div>
            </div>

            <div id="skipIntroBtn" class="skip-intro" onclick="skipIntro()">
                <span>Saltar Intro</span> <i class="fa-solid fa-forward"></i>
            </div>
            
            <div class="bottom-area">
                <div class="progress-container" onclick="handleSeekClick(event)">
                    <div class="progress-bg"></div>
                    <div id="progBuffer" class="progress-buffer"></div> <div id="progFill" class="progress-fill"></div>
                </div>
                
                <div class="controls-row">
                    <div class="left-controls">
                        <i id="bottomPlayBtn" class="fa-solid fa-play icon-btn" onclick="togglePlay()" style="font-size:1.3rem;"></i>
                        <div class="time-text" id="timeDisplay">00:00 / 00:00</div>
                    </div>
                    <i class="fa-solid fa-expand icon-btn" onclick="toggleFS()" style="font-size:1.4rem;"></i>
                </div>

            </div>
        </div>
    </div>

    <div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawers()"></div>

    <div id="drawer-speed" class="drawer">
        <div class="drawer-header">
            <span>Velocidad</span>
            <i class="fa-solid fa-xmark" onclick="closeDrawers()"></i>
        </div>
        <div class="speed-grid">
            <div class="speed-btn" onclick="setSpeed(0.5)">0.5x</div>
            <div class="speed-btn active" id="sp-1" onclick="setSpeed(1)">1x</div>
            <div class="speed-btn" onclick="setSpeed(1.25)">1.25x</div>
            <div class="speed-btn" onclick="setSpeed(1.5)">1.5x</div>
            <div class="speed-btn" onclick="setSpeed(2)">2.0x</div>
        </div>
    </div>

    <div id="drawer-eps" class="drawer">
        <div class="drawer-header">
            <span>Episodios</span>
            <i class="fa-solid fa-xmark" onclick="closeDrawers()"></i>
        </div>
        <div id="epList" class="ep-list"></div>
    </div>

    <script>
        // --- ESTADO ---
        let playerType = 'none';
        let ytPlayer = null;
        let html5Player = document.getElementById('html5-player');
        let itemData = null;
        let currentEp = 0;
        let isSerie = false;
        let isPlayingIntro = false;
        let isLocked = false;
        let uiTimeout = null;
        let currentSpeed = 1;
        let currentVol = 1;
        let currentBright = 1;
        
        let touchStartY = 0;
        let activeGesture = null;
        let lastClickTime = 0;

        let sourceQueue = [];
        let currentSourceIndex = 0;
        
        // --- URL INTRO ---
        const INTRO_URL = "https://ia601709.us.archive.org/4/items/gemini_generated_video_B83D69A3/gemini_generated_video_B83D69A3.mp4";
        
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        // --- INICIO ---
        window.onload = async () => {
            initGestures();
            initSystemInfo();
            
            html5Player.onerror = () => {
                if(isPlayingIntro) { handleHtml5Ended(); return; }
                tryNextSource();
            };
            html5Player.onended = handleHtml5Ended;

            if (!id) {
                document.getElementById('ui-title').innerText = "Flechazo Demo Ultimate";
                document.getElementById('ui-subtitle').innerText = "Prueba de Gestos";
                sourceQueue = ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4"];
                startPlaybackSequence();
                return;
            }

            try {
                const res = await fetch(`/api/movies/${id}`);
                if (!res.ok) throw new Error("API Error");
                itemData = await res.json();

                if(itemData.tipo === 'serie') {
                    isSerie = true;
                    document.getElementById('btnEpList').style.display = 'flex';
                    prepareEp(0);
                } else {
                    document.getElementById('ui-title').innerText = itemData.title;
                    buildSourceQueue(itemData);
                    startPlaybackSequence();
                }
            } catch(e) { console.error(e); }
        };

        // --- SISTEMA RELOJ Y BATERIA ---
        function initSystemInfo() {
            setInterval(() => {
                const now = new Date();
                const h = now.getHours().toString().padStart(2,'0');
                const m = now.getMinutes().toString().padStart(2,'0');
                document.getElementById('sysTime').innerText = `${h}:${m}`;
            }, 1000);

            if(navigator.getBattery) {
                navigator.getBattery().then(batt => {
                    updateBattery(batt);
                    batt.addEventListener('levelchange', () => updateBattery(batt));
                    batt.addEventListener('chargingchange', () => updateBattery(batt));
                });
            }
        }

        function updateBattery(batt) {
            const level = Math.round(batt.level * 100);
            const icon = document.getElementById('battIcon');
            const isCharging = batt.charging;
            
            icon.className = isCharging ? "fa-solid fa-bolt battery-icon" : 
                             level > 80 ? "fa-solid fa-battery-full battery-icon" :
                             level > 50 ? "fa-solid fa-battery-three-quarters battery-icon" :
                             level > 20 ? "fa-solid fa-battery-quarter battery-icon" :
                             "fa-solid fa-battery-empty battery-icon";
            
            if(level < 20 && !isCharging) icon.style.color = '#ff3366';
            else icon.style.color = '#0f0';
        }

        // --- GESTIÓN DE FUENTES ---
        function buildSourceQueue(data) {
            sourceQueue = [];
            if(data.url) sourceQueue.push(data.url);
            if(data.backupUrl) sourceQueue.push(data.backupUrl);
            if(data.mirrors) sourceQueue = sourceQueue.concat(data.mirrors);
            if(sourceQueue.length === 0) sourceQueue.push("");
        }
        function tryNextSource() {
            currentSourceIndex++;
            if(currentSourceIndex < sourceQueue.length) loadMainVideo(sourceQueue[currentSourceIndex]);
        }

        // --- PLAYBACK ---
        function startPlaybackSequence() {
            currentSourceIndex = 0;
            playIntro();
        }

        function playIntro() {
            isPlayingIntro = true;
            playerType = 'intro';
            
            html5Player.classList.remove('hidden');
            document.getElementById('yt-placeholder').classList.add('hidden');
            
            html5Player.src = INTRO_URL;
            html5Player.muted = true;
            updateBottomIcon(true); // Icono Pausa
            
            var playPromise = html5Player.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => { console.log("Intro iniciada auto"); })
                .catch(error => { 
                    document.getElementById('bigPlay').classList.add('show-play'); 
                    updateBottomIcon(false); // Icono Play si falla
                });
            }
        }

        function handleHtml5Ended() {
            if(isPlayingIntro) {
                isPlayingIntro = false;
                html5Player.muted = false; 
                if(sourceQueue.length > 0) loadMainVideo(sourceQueue[0]);
            } else if(isSerie) {
                showNextButton();
                updateBottomIcon(false); // Video terminó, mostrar play
            }
        }

        function loadMainVideo(url) {
            document.getElementById('spinner').style.display = 'block';
            const savedTime = localStorage.getItem(`flechazo_time_${id}_${currentEp}`) || 0;
            const ytId = getYouTubeId(url);
            
            if (ytId) {
                playerType = 'youtube';
                html5Player.classList.add('hidden');
                html5Player.pause();
                initYouTubePlayer(ytId, parseFloat(savedTime));
            } else {
                playerType = 'html5';
                if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
                document.getElementById('yt-placeholder').classList.add('hidden');
                html5Player.classList.remove('hidden');
                
                html5Player.src = url;
                html5Player.currentTime = parseFloat(savedTime);
                html5Player.playbackRate = currentSpeed;
                html5Player.muted = false;

                html5Player.play().catch(e=>console.log(e));
                updateBottomIcon(true); // Icono Pausa
                
                html5Player.onplaying = () => {
                    document.getElementById('spinner').style.display = 'none';
                    resetUiTimer();
                    updateBottomIcon(true);
                };
                html5Player.onpause = () => updateBottomIcon(false);
                html5Player.onwaiting = () => document.getElementById('spinner').style.display = 'block';
                html5Player.ontimeupdate = updateProgressLoop;
            }
        }

        // --- GESTOS ---
        function initGestures() {
            const layer = document.getElementById('gestureLayer');
            
            // CLICK
            layer.addEventListener('click', (e) => {
                if(isLocked) { animateLockBtn(); return; }
                const now = new Date().getTime();
                if(now - lastClickTime < 300) {
                    const w = window.innerWidth;
                    if(e.clientX < w/3) seek(-10);
                    else if(e.clientX > w*2/3) seek(10);
                    else togglePlay();
                } else {
                    setTimeout(() => {
                        if(new Date().getTime() - lastClickTime > 300) {
                            const ui = document.getElementById('uiLayer');
                            ui.classList.contains('hidden-ui') ? resetUiTimer() : togglePlay();
                        }
                    }, 310);
                }
                lastClickTime = now;
            });

            // SWIPE START
            layer.addEventListener('touchstart', (e) => {
                if(isLocked) return;
                resetUiTimer();
                touchStartY = e.touches[0].clientY;
                const x = e.touches[0].clientX;
                const w = window.innerWidth;
                if(x < w/2) activeGesture = 'bright';
                else activeGesture = 'vol';
            });

            // SWIPE MOVE
            layer.addEventListener('touchmove', (e) => {
                if(isLocked || !activeGesture) return;
                if (e.cancelable) e.preventDefault();
                resetUiTimer();
                
                const y = e.touches[0].clientY;
                const delta = touchStartY - y;
                
                if(Math.abs(delta) > 5) {
                    const sensitivity = 2;
                    const step = (delta / window.innerHeight) * sensitivity;
                    if(activeGesture === 'vol') setVolume(currentVol + step);
                    if(activeGesture === 'bright') setBrightness(currentBright + step);
                    touchStartY = y;
                }
            });

            layer.addEventListener('touchend', () => {
                activeGesture = null;
                setTimeout(() => document.getElementById('centerFeedback').classList.remove('visible'), 500);
            });
        }

        function setVolume(val) {
            currentVol = Math.max(0, Math.min(1, val));
            if(html5Player) {
                html5Player.volume = currentVol;
                if(val > 0) html5Player.muted = false; 
            }
            if(ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(currentVol * 100);
            
            let icon = 'fa-volume-low';
            if(currentVol > 0.5) icon = 'fa-volume-high';
            if(currentVol === 0) icon = 'fa-volume-xmark';
            
            showFeedback(icon, Math.round(currentVol * 100) + '%');
        }

        function setBrightness(val) {
            currentBright = Math.max(0.2, Math.min(1, val));
            document.getElementById('brightness-overlay').style.opacity = (1 - currentBright);
            showFeedback('fa-sun', Math.round(currentBright * 100) + '%');
        }

        function showFeedback(iconClass, text) {
            const el = document.getElementById('centerFeedback');
            document.getElementById('feedIcon').className = `fa-solid ${iconClass} feedback-icon`;
            document.getElementById('feedText').innerText = text;
            el.classList.add('visible');
        }

        function toggleLock() {
            isLocked = !isLocked;
            const ui = document.getElementById('uiLayer');
            const lockBtn = document.getElementById('unlockBtn');
            const container = document.getElementById('mainContainer');
            
            if(isLocked) {
                ui.classList.add('hidden-ui');
                container.classList.add('hide-cursor');
                lockBtn.style.display = 'flex';
                showFeedback('fa-lock', 'Bloqueado');
            } else {
                lockBtn.style.display = 'none';
                resetUiTimer();
                showFeedback('fa-lock-open', 'Desbloqueado');
            }
            setTimeout(() => document.getElementById('centerFeedback').classList.remove('visible'), 1000);
        }

        // --- FUNCIONES UI PRO ---
        function resetUiTimer() {
            if(isLocked) return;
            
            const ui = document.getElementById('uiLayer');
            const container = document.getElementById('mainContainer');
            
            ui.classList.remove('hidden-ui');
            container.classList.remove('hide-cursor');
            
            clearTimeout(uiTimeout);
            
            const isPlaying = (playerType === 'html5' && !html5Player.paused && !html5Player.ended) || 
                              (playerType === 'youtube' && ytPlayer && ytPlayer.getPlayerState() === 1);
            
            if(isPlaying) {
                uiTimeout = setTimeout(() => {
                    ui.classList.add('hidden-ui');
                    container.classList.add('hide-cursor');
                    closeDrawers();
                }, 3000);
            }
        }

        function updateBottomIcon(isPlaying) {
            const btn = document.getElementById('bottomPlayBtn');
            if(isPlaying) {
                btn.className = "fa-solid fa-pause icon-btn";
            } else {
                btn.className = "fa-solid fa-play icon-btn";
            }
        }

        function togglePlay() {
            if(isLocked) return;
            
            const bigPlay = document.getElementById('bigPlay');
            
            if(playerType === 'html5') {
                if(isPlayingIntro && html5Player.muted) {
                    html5Player.muted = false;
                    showFeedback('fa-volume-high', 'Sonido On');
                }
                if(html5Player.paused) { 
                    html5Player.play(); 
                    bigPlay.classList.remove('show-play'); 
                    updateBottomIcon(true);
                    resetUiTimer();
                } 
                else { 
                    html5Player.pause(); 
                    bigPlay.classList.add('show-play'); 
                    updateBottomIcon(false);
                    resetUiTimer(); 
                }
            } else if(playerType === 'youtube' && ytPlayer) {
                if(ytPlayer.getPlayerState() === 1) { 
                    ytPlayer.pauseVideo(); 
                    bigPlay.classList.add('show-play'); 
                    updateBottomIcon(false);
                    resetUiTimer();
                }
                else { 
                    ytPlayer.playVideo(); 
                    bigPlay.classList.remove('show-play'); 
                    updateBottomIcon(true);
                    resetUiTimer();
                }
            }
        }

        // --- UPDATE LOOP ---
        function updateProgressLoop() {
            if(isPlayingIntro) return;
            
            let cur = 0, dur = 0, buff = 0;
            if(playerType === 'html5') {
                cur = html5Player.currentTime;
                dur = html5Player.duration;
                if (html5Player.buffered.length > 0) {
                    buff = html5Player.buffered.end(html5Player.buffered.length - 1);
                }
            } else if(ytPlayer && ytPlayer.getCurrentTime) {
                cur = ytPlayer.getCurrentTime();
                dur = ytPlayer.getDuration();
                buff = ytPlayer.getVideoLoadedFraction() * dur;
            }

            if(dur > 0) {
                document.getElementById('progFill').style.width = (cur/dur)*100 + '%';
                document.getElementById('progBuffer').style.width = (buff/dur)*100 + '%';
                document.getElementById('timeDisplay').innerText = formatTime(cur) + " / " + formatTime(dur);
                
                checkSkipIntro(cur);
                if(Math.floor(cur)%5 === 0) localStorage.setItem(`flechazo_time_${id}_${currentEp}`, cur);
                if(isSerie && (dur - cur < 60)) showNextButton();
            }
        }

        function seek(sec) {
            if(isLocked) return;
            if(playerType==='html5') html5Player.currentTime += sec;
            else if(ytPlayer) ytPlayer.seekTo(ytPlayer.getCurrentTime()+sec, true);
            
            const el = document.getElementById(sec > 0 ? 'seekRight' : 'seekLeft');
            el.classList.remove('visible'); void el.offsetWidth; el.classList.add('visible');
            resetUiTimer();
        }
        
        function handleSeekClick(e) {
            if(isLocked) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            if(playerType === 'html5' && html5Player.duration) html5Player.currentTime = html5Player.duration * pct;
            else if(ytPlayer) ytPlayer.seekTo(ytPlayer.getDuration() * pct, true);
        }

        // --- HELPERS ---
        function formatTime(s) {
            if(!s || isNaN(s)) return "00:00";
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec<10?'0'+sec:sec}`;
        }
        function checkSkipIntro(cur) {
            const btn = document.getElementById('skipIntroBtn');
            if(cur > 10 && cur < 90) btn.classList.add('visible');
            else btn.classList.remove('visible');
        }
        function skipIntro() { seek(85); showFeedback('fa-forward-step', 'Intro Saltada'); }
        function showNextButton() {
            const btn = document.getElementById('btnNext');
            btn.style.display = 'flex';
            setTimeout(() => btn.style.transform = 'scale(1)', 100);
        }
        function animateLockBtn() {
            const btn = document.getElementById('unlockBtn');
            btn.style.transform = "translateX(-50%) scale(1.1)";
            setTimeout(() => btn.style.transform = "translateX(-50%) scale(1)", 200);
        }

        // --- DRAWERS ---
        function toggleDrawer(id) {
            if(isLocked) return;
            closeDrawers();
            document.getElementById('drawer-'+id).classList.add('open');
            document.getElementById('drawerOverlay').classList.add('open');
            if(id === 'eps') renderEpList();
        }
        function closeDrawers() {
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
            document.getElementById('drawerOverlay').classList.remove('open');
            resetUiTimer();
        }
        function setSpeed(rate) {
            currentSpeed = rate;
            if(html5Player) html5Player.playbackRate = rate;
            if(ytPlayer) ytPlayer.setPlaybackRate(rate);
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            closeDrawers();
            showFeedback('fa-gauge-high', rate + 'x');
        }
        function renderEpList() {
            const list = document.getElementById('epList');
            list.innerHTML = '';
            itemData.episodios.forEach((ep, i) => {
                const div = document.createElement('div');
                div.className = `ep-item ${i===currentEp ? 'active' : ''}`;
                div.innerHTML = `<div class="ep-num">${ep.numero}</div><div>${ep.titulo || 'Episodio '+ep.numero}</div>`;
                div.onclick = () => { prepareEp(i); closeDrawers(); };
                list.appendChild(div);
            });
        }
        function prepareEp(i) {
            if(!itemData.episodios[i]) return;
            currentEp = i;
            document.getElementById('ui-title').innerText = `Episodio ${itemData.episodios[i].numero}`;
            buildSourceQueue(itemData.episodios[i]);
            startPlaybackSequence();
            document.getElementById('btnNext').style.transform = 'scale(0)';
        }
        function nextEp() { if(isSerie && currentEp+1 < itemData.episodios.length) prepareEp(currentEp+1); }

        function toggleFS() { 
            if(!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if(document.exitFullscreen) document.exitFullscreen();
        }
        function goBack() { window.history.back(); }

        // YOUTUBE
        function getYouTubeId(url) {
            if (!url) return null;
            const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (m && m[2].length === 11) ? m[2] : null;
        }
        function initYouTubePlayer(videoId, start) {
            if (!window.YT || !window.YT.Player) { setTimeout(() => initYouTubePlayer(videoId, start), 100); return; }
            if (ytPlayer) { document.getElementById('yt-placeholder').classList.remove('hidden'); ytPlayer.loadVideoById(videoId, start); return; }
            ytPlayer = new YT.Player('yt-placeholder', {
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'start': Math.floor(start), 'playsinline': 1, 'fs': 0 },
                events: { 'onReady': (e)=>{e.target.setPlaybackRate(currentSpeed); e.target.playVideo(); setInterval(updateProgressLoop, 500);}, 
                'onStateChange': (e)=>{ 
                    if(e.data===YT.PlayerState.PLAYING){
                        document.getElementById('spinner').style.display='none'; 
                        resetUiTimer();
                        updateBottomIcon(true);
                    } 
                    if(e.data===YT.PlayerState.PAUSED){
                        document.getElementById('bigPlay').classList.add('show-play'); 
                        updateBottomIcon(false);
                    }
                    if(e.data===YT.PlayerState.ENDED && isSerie)showNextButton(); 
                } 
            }
            });
            document.getElementById('yt-placeholder').classList.remove('hidden');
        }
    </script>
</body>
</html>
