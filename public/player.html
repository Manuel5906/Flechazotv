<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Flechazo Player ULTRA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <style>
        /* --- CORE --- */
        html, body {
            margin: 0; padding: 0; background: #000; color: white;
            font-family: 'Segoe UI', Roboto, sans-serif;
            height: 100dvh; width: 100vw; overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .video-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; align-items: center; justify-content: center;
        }

        video, #yt-placeholder { width: 100%; height: 100%; object-fit: contain; position: absolute; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }

        /* --- CAPAS DE GESTOS Y BRILLO --- */
        #brightness-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; opacity: 0; pointer-events: none; z-index: 25;
            transition: opacity 0.1s;
        }

        /* Áreas táctiles invisibles para gestos */
        .gesture-area { position: absolute; top: 20%; bottom: 20%; width: 40%; z-index: 28; }
        .gesture-left { left: 0; }
        .gesture-right { right: 0; }

        /* Icono central de feedback (Volumen/Brillo) */
        .center-feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px;
            text-align: center; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 50;
            backdrop-filter: blur(5px);
        }
        .center-feedback.visible { opacity: 1; }
        .feedback-icon { font-size: 2.5rem; color: #ff3366; margin-bottom: 5px; }
        .feedback-text { font-size: 1.2rem; font-weight: bold; }

        /* --- UI LAYER --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 30; display: flex; flex-direction: column; justify-content: space-between;
            transition: opacity 0.3s;
        }
        .ui-layer.hidden-ui { opacity: 0; pointer-events: none; }

        /* Top Bar */
        .top-bar {
            padding: 15px 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex; align-items: center; gap: 15px;
        }
        .video-info { flex: 1; }
        .video-title { font-weight: 700; font-size: 1rem; }
        .video-subtitle { font-size: 0.8rem; color: #ccc; }
        .top-icons { display: flex; gap: 20px; font-size: 1.3rem; }

        /* Center Play Button */
        .center-play {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4rem; color: rgba(255,255,255,0.7); pointer-events: none;
            opacity: 0; transition: transform 0.2s, opacity 0.2s;
        }
        .paused .center-play { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* Sidebar & Lock */
        .sidebar {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 25px; align-items: center;
        }
        .side-icon {
            font-size: 1.4rem; color: white; background: rgba(0,0,0,0.5);
            width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .side-icon:active { transform: scale(0.9); background: #ff3366; }

        /* Botón de desbloqueo (aparece solo cuando está bloqueado) */
        #unlockBtn {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 51, 102, 0.9); padding: 10px 20px; border-radius: 30px;
            display: flex; align-items: center; gap: 10px; font-weight: bold;
            z-index: 60; cursor: pointer; display: none;
        }

        /* --- CONTROLS BOTTOM --- */
        .bottom-area {
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 10px 20px 30px;
        }
        .progress-container { width: 100%; height: 20px; display: flex; align-items: center; margin-bottom: 5px; cursor: pointer; }
        .progress-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; position: relative; }
        .progress-fill { height: 100%; width: 0%; background: #ff3366; border-radius: 2px; position: relative; }
        .progress-fill::after { 
            content: ''; position: absolute; right: -6px; top: -5px; width: 14px; height: 14px; 
            background: white; border-radius: 50%; transform: scale(0); transition: transform 0.2s; 
        }
        .progress-container:active .progress-fill::after { transform: scale(1); }

        .controls-row { display: flex; justify-content: space-between; align-items: center; }
        .time-text { font-family: monospace; font-size: 0.9rem; font-weight: 600; }

        /* --- MENÚ VELOCIDAD --- */
        .speed-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; background: #1a1a1a;
            border-radius: 20px 20px 0 0; padding: 20px; transform: translateY(110%);
            transition: transform 0.3s; z-index: 40; display: flex; flex-direction: column; gap: 10px;
        }
        .speed-overlay.open { transform: translateY(0); }
        .speed-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .speed-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .speed-item { 
            background: #333; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem; cursor: pointer; 
        }
        .speed-item.active { background: #ff3366; color: white; font-weight: bold; }

        /* --- SEEK ANIMATION --- */
        .seek-badge {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 50%;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 20;
        }
        .seek-badge.visible { opacity: 1; animation: pop 0.3s; }
        @keyframes pop { 0% { transform: translateY(-50%) scale(0.5); } 50% { transform: translateY(-50%) scale(1.2); } 100% { transform: translateY(-50%) scale(1); } }

        /* Spinner & Error */
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: #ff3366; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; position: absolute; display: none; z-index: 5; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="brightness-overlay"></div>

    <div class="video-container" id="mainContainer">
        <video id="html5-player" class="hidden" playsinline></video>
        <div id="yt-placeholder"></div>
        <div id="spinner" class="spinner"></div>

        <div id="centerFeedback" class="center-feedback">
            <i id="feedIcon" class="fa-solid fa-volume-high feedback-icon"></i>
            <div id="feedText" class="feedback-text">100%</div>
        </div>

        <div id="seekLeft" class="seek-badge" style="left: 20%;"><i class="fa-solid fa-backward"></i> 10s</div>
        <div id="seekRight" class="seek-badge" style="right: 20%;"><i class="fa-solid fa-forward"></i> 10s</div>

        <div id="gestureLayer" style="position:absolute; width:100%; height:100%; z-index:29;">
            <div class="gesture-area gesture-left"></div> <div class="gesture-area gesture-right"></div> </div>

        <div id="unlockBtn" onclick="toggleLock()">
            <i class="fa-solid fa-lock-open"></i> Desbloquear
        </div>

        <div id="uiLayer" class="ui-layer">
            
            <div class="top-bar">
                <i class="fa-solid fa-arrow-left" onclick="history.back()" style="font-size:1.5rem; cursor:pointer;"></i>
                <div class="video-info">
                    <div class="video-title" id="ui-title">Cargando...</div>
                    <div class="video-subtitle" id="ui-sub">Flechazo TV</div>
                </div>
                <div class="top-icons">
                    <i class="fa-solid fa-gauge-high" onclick="toggleSpeedMenu()"></i>
                    <i class="fa-solid fa-lock" onclick="toggleLock()"></i>
                </div>
            </div>

            <div class="center-play" id="centerPlayIcon">
                <i class="fa-solid fa-play"></i>
            </div>

            <div class="sidebar">
                <div class="side-icon" onclick="toggleFit()"><i id="fitIcon" class="fa-solid fa-expand"></i></div>
                <div class="side-icon" onclick="openEpList()" id="btnEp" style="display:none;"><i class="fa-solid fa-list"></i></div>
            </div>

            <div class="bottom-area">
                <div class="progress-container" onclick="handleSeekClick(event)">
                    <div class="progress-bg"><div id="progFill" class="progress-fill"></div></div>
                </div>
                <div class="controls-row">
                    <div class="time-text" id="timeDisplay">00:00 / 00:00</div>
                    <i class="fa-solid fa-maximize" style="font-size:1.2rem; cursor:pointer;" onclick="toggleFS()"></i>
                </div>
            </div>
        </div>

        <div id="speedMenu" class="speed-overlay">
            <div class="speed-header">
                <span>Velocidad de reproducción</span>
                <i class="fa-solid fa-xmark" onclick="toggleSpeedMenu()"></i>
            </div>
            <div class="speed-grid">
                <div class="speed-item" onclick="setSpeed(0.25)">0.25x</div>
                <div class="speed-item" onclick="setSpeed(0.5)">0.5x</div>
                <div class="speed-item" onclick="setSpeed(0.75)">0.75x</div>
                <div class="speed-item active" id="sp-1" onclick="setSpeed(1)">Normal</div>
                <div class="speed-item" onclick="setSpeed(1.25)">1.25x</div>
                <div class="speed-item" onclick="setSpeed(1.5)">1.5x</div>
                <div class="speed-item" onclick="setSpeed(1.75)">1.75x</div>
                <div class="speed-item" onclick="setSpeed(2)">2.0x</div>
            </div>
        </div>

    </div>

    <script>
        // --- ESTADO ---
        let playerType = 'none'; // 'html5' | 'youtube'
        let ytPlayer = null;
        let html5Player = document.getElementById('html5-player');
        let isLocked = false;
        let uiTimeout = null;
        let currentVol = 1;
        let currentBright = 1; // 1 = sin oscuridad, 0 = negro total
        let currentSpeed = 1;

        // Gestos
        let touchStartY = 0;
        let activeGesture = null; // 'vol' | 'bright' | null

        // Demo Data
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        
        // --- INICIO ---
        window.onload = () => {
            initGestures();
            // Simular carga o API
            if(!id) {
                document.getElementById('ui-title').innerText = "Flechazo Pro: Demo";
                loadVideo("https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4", 'html5');
            }
        };

        // --- CORE PLAYER ---
        function loadVideo(url, type) {
            document.getElementById('spinner').style.display = 'block';
            playerType = type;
            
            if(type === 'html5') {
                html5Player.classList.remove('hidden');
                html5Player.src = url;
                html5Player.load();
                html5Player.play();
                html5Player.onplaying = () => { 
                    document.getElementById('spinner').style.display = 'none';
                    resetUiTimer();
                };
                html5Player.ontimeupdate = updateProgress;
                html5Player.onended = () => showUi(true);
            }
        }

        function togglePlay() {
            if(playerType === 'html5') {
                if(html5Player.paused) {
                    html5Player.play();
                    document.getElementById('mainContainer').classList.remove('paused');
                    resetUiTimer();
                } else {
                    html5Player.pause();
                    document.getElementById('mainContainer').classList.add('paused');
                    showUi(true); // Mantener UI visible en pausa
                }
            }
        }

        // --- GESTIÓN DE UI (TAP & TIMEOUT) ---
        function resetUiTimer() {
            if(isLocked) return;
            const ui = document.getElementById('uiLayer');
            ui.classList.remove('hidden-ui');
            clearTimeout(uiTimeout);
            
            // Solo ocultar si está reproduciendo
            if(playerType === 'html5' && !html5Player.paused) {
                uiTimeout = setTimeout(() => {
                    ui.classList.add('hidden-ui');
                    document.getElementById('speedMenu').classList.remove('open');
                }, 3500);
            }
        }

        function showUi(forceKeep) {
            document.getElementById('uiLayer').classList.remove('hidden-ui');
            clearTimeout(uiTimeout);
            if(!forceKeep) resetUiTimer();
        }

        // Click principal en pantalla
        document.getElementById('gestureLayer').addEventListener('click', (e) => {
            if(isLocked) {
                // Animación de "está bloqueado"
                const btn = document.getElementById('unlockBtn');
                btn.style.transform = "translateX(-50%) scale(1.1)";
                setTimeout(()=> btn.style.transform = "translateX(-50%) scale(1)", 200);
                return;
            }

            const now = new Date().getTime();
            if(lastClick && (now - lastClick < 300)) {
                // Double tap logic (buscar zonas)
                const w = window.innerWidth;
                if(e.clientX < w/3) seek(-10);
                else if(e.clientX > w*2/3) seek(10);
                else togglePlay();
            } else {
                // Single tap
                setTimeout(() => {
                   if(new Date().getTime() - lastClick > 300) {
                       const ui = document.getElementById('uiLayer');
                       ui.classList.contains('hidden-ui') ? resetUiTimer() : togglePlay();
                   }
                }, 310);
            }
            lastClick = now;
        });
        let lastClick = 0;

        // --- GESTOS TÁCTILES (VOLUME & BRIGHTNESS) ---
        function initGestures() {
            const layer = document.getElementById('gestureLayer');
            
            layer.addEventListener('touchstart', (e) => {
                if(isLocked) return;
                touchStartY = e.touches[0].clientY;
                const x = e.touches[0].clientX;
                const w = window.innerWidth;
                
                // Determinar zona
                if(x < w/2) activeGesture = 'bright';
                else activeGesture = 'vol';
            });

            layer.addEventListener('touchmove', (e) => {
                if(isLocked || !activeGesture) return;
                e.preventDefault(); // Evitar scroll
                
                const y = e.touches[0].clientY;
                const delta = touchStartY - y; // Positivo si sube, negativo si baja
                
                // Sensibilidad
                if(Math.abs(delta) > 10) {
                    const step = delta / window.innerHeight * 1.5; // Factor de velocidad
                    
                    if(activeGesture === 'vol') changeVol(step);
                    if(activeGesture === 'bright') changeBright(step);
                    
                    touchStartY = y; // Reset para movimiento continuo
                }
            });

            layer.addEventListener('touchend', () => {
                activeGesture = null;
                setTimeout(() => document.getElementById('centerFeedback').classList.remove('visible'), 500);
            });
        }

        function changeVol(step) {
            currentVol = Math.min(Math.max(currentVol + step, 0), 1);
            if(html5Player) html5Player.volume = currentVol;
            
            showFeedback('vol', Math.round(currentVol * 100) + '%');
        }

        function changeBright(step) {
            currentBright = Math.min(Math.max(currentBright + step, 0.2), 1); // Min 0.2 para no negro total
            // El overlay negro varía de opacidad 0 (brillo max) a 0.8 (oscuro)
            const opacity = 1 - currentBright;
            document.getElementById('brightness-overlay').style.opacity = opacity;
            
            showFeedback('bright', Math.round(currentBright * 100) + '%');
        }

        function showFeedback(type, text) {
            const el = document.getElementById('centerFeedback');
            const icon = document.getElementById('feedIcon');
            const txt = document.getElementById('feedText');
            
            el.classList.add('visible');
            txt.innerText = text;
            
            if(type === 'vol') {
                icon.className = currentVol > 0.5 ? "fa-solid fa-volume-high feedback-icon" : (currentVol > 0 ? "fa-solid fa-volume-low feedback-icon" : "fa-solid fa-volume-xmark feedback-icon");
            } else {
                icon.className = "fa-solid fa-sun feedback-icon";
            }
        }

        // --- FUNCIONES EXTRA ---
        function toggleLock() {
            isLocked = !isLocked;
            const ui = document.getElementById('uiLayer');
            const unlockBtn = document.getElementById('unlockBtn');
            
            if(isLocked) {
                ui.classList.add('hidden-ui'); // Ocultar UI inmediatamente
                unlockBtn.style.display = 'flex';
                // Mensaje temporal
                showFeedback('lock', 'Bloqueado');
                document.getElementById('feedIcon').className = 'fa-solid fa-lock';
                setTimeout(() => document.getElementById('centerFeedback').classList.remove('visible'), 1000);
            } else {
                unlockBtn.style.display = 'none';
                resetUiTimer();
                showFeedback('unlock', 'Desbloqueado');
                document.getElementById('feedIcon').className = 'fa-solid fa-lock-open';
                setTimeout(() => document.getElementById('centerFeedback').classList.remove('visible'), 1000);
            }
        }

        function toggleSpeedMenu() {
            if(isLocked) return;
            document.getElementById('speedMenu').classList.toggle('open');
        }

        function setSpeed(rate) {
            currentSpeed = rate;
            if(html5Player) html5Player.playbackRate = rate;
            
            // Update UI Styles
            document.querySelectorAll('.speed-item').forEach(i => i.classList.remove('active'));
            // Esto es simple, en prod usar IDs unicos
            event.target.classList.add('active');
            
            toggleSpeedMenu();
            showFeedback('speed', rate + 'x');
            document.getElementById('feedIcon').className = 'fa-solid fa-person-running';
            setTimeout(() => document.getElementById('centerFeedback').classList.remove('visible'), 1000);
        }

        function seek(sec) {
            if(isLocked) return;
            if(html5Player) html5Player.currentTime += sec;
            
            // Animación visual
            const id = sec > 0 ? 'seekRight' : 'seekLeft';
            const el = document.getElementById(id);
            el.classList.remove('visible');
            void el.offsetWidth; // Trigger reflow
            el.classList.add('visible');
            resetUiTimer();
        }

        function handleSeekClick(e) {
            if(isLocked) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const pct = (e.clientX - rect.left) / rect.width;
            if(html5Player) html5Player.currentTime = html5Player.duration * pct;
        }

        function updateProgress() {
            if(html5Player.duration) {
                const cur = html5Player.currentTime;
                const dur = html5Player.duration;
                const pct = (cur/dur)*100;
                document.getElementById('progFill').style.width = pct + '%';
                document.getElementById('timeDisplay').innerText = formatTime(cur) + " / " + formatTime(dur);
            }
        }

        function formatTime(s) {
            const m = Math.floor(s/60);
            const sec = Math.floor(s%60);
            return `${m}:${sec<10?'0'+sec:sec}`;
        }

        function toggleFS() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
