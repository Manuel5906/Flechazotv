<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Flechazo Player ULTIMATE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <style>
        /* --- CORE SYSTEM --- */
        html, body {
            margin: 0; padding: 0; background: #000; color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100dvh; width: 100vw; overflow: hidden;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .video-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; align-items: center; justify-content: center;
            cursor: default; overflow: hidden;
        }
        
        .video-container.hide-cursor { cursor: none; }

        video, #yt-placeholder { 
            width: 100%; height: 100%; 
            object-fit: contain; 
            position: absolute; z-index: 0; 
            transition: transform 0.3s ease, object-fit 0.3s ease;
        }
        
        .video-zoomed video { object-fit: cover !important; }
        .video-zoomed #yt-placeholder { transform: scale(1.35); } 

        .hidden { opacity: 0; pointer-events: none; }

        /* --- VISUAL LAYERS --- */
        #brightness-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; opacity: 0; pointer-events: none; z-index: 10;
            transition: opacity 0.1s;
        }

        #gestureLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; touch-action: none; 
        }

        /* Smart Seek Layers */
        .seek-layer {
            position: absolute; top: 0; bottom: 0; width: 35%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 45; opacity: 0; pointer-events: none; transition: opacity 0.2s ease-out;
            color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .seek-layer.left {
            left: 0;
            background: radial-gradient(circle at left, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            border-top-right-radius: 50% 100%; border-bottom-right-radius: 50% 100%;
        }

        .seek-layer.right {
            right: 0;
            background: radial-gradient(circle at right, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
            border-top-left-radius: 50% 100%; border-bottom-left-radius: 50% 100%;
        }

        .seek-layer.visible { opacity: 1; }
        .seek-icon-group { font-size: 2.5rem; margin-bottom: 5px; opacity: 0.9; }
        .seek-text { font-size: 1.2rem; font-weight: 800; font-family: sans-serif; letter-spacing: 1px; }

        .pulse-anim { animation: pulseArrow 0.6s infinite alternate; }
        @keyframes pulseArrow { from { transform: translateX(0); opacity: 0.6; } to { transform: translateX(3px); opacity: 1; } }
        .fa-backward.pulse-anim { animation-direction: reverse; }

        /* Feedback Central */
        .center-feedback {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.6); padding: 25px; border-radius: 20px;
            text-align: center; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 60;
            backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; min-width: 100px;
        }
        .center-feedback.visible { opacity: 1; }
        .feedback-icon { font-size: 2.5rem; color: #ff3366; margin-bottom: 10px; }
        .feedback-text { font-size: 1.2rem; font-weight: 800; }

        /* --- UI LAYER --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: flex; flex-direction: column; justify-content: space-between;
            transition: opacity 0.4s ease-in-out;
            pointer-events: none;
        }
        .ui-layer.hidden-ui { opacity: 0; }
        .ui-layer > * { pointer-events: auto; }

        .top-bar {
            padding: max(15px, env(safe-area-inset-top)) 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 60%, transparent 100%);
            display: flex; align-items: center; gap: 15px;
        }
        .video-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .video-title { font-weight: 700; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .video-subtitle { font-size: 0.85rem; color: #ccc; text-shadow: 0 1px 3px rgba(0,0,0,0.8); margin-top: 2px; }
        
        .quality-badge {
            background: rgba(255,255,255,0.2); color: #fff; padding: 2px 6px; 
            border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.4);
            margin-left: 8px; vertical-align: middle;
        }

        .top-icons { display: flex; gap: 25px; font-size: 1.4rem; margin-left: 10px; align-items: center; }
        .icon-btn { cursor: pointer; filter: drop-shadow(0 2px 2px black); transition: color 0.2s, transform 0.1s; color: white; }
        .icon-btn:active { color: #ff3366; transform: scale(0.9); }

        .skip-intro {
            position: absolute; bottom: 100px; left: 20px;
            background: white; color: black; padding: 10px 20px; border-radius: 8px;
            font-size: 0.9rem; font-weight: 800; display: flex; align-items: center; gap: 10px;
            cursor: pointer; opacity: 0; transform: translateY(20px); pointer-events: none;
            transition: all 0.4s ease; z-index: 55; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .skip-intro.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

        #unlockBtn {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 51, 102, 0.9); padding: 12px 30px; border-radius: 30px;
            display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1rem;
            z-index: 99; cursor: pointer; display: none; box-shadow: 0 0 20px rgba(255, 51, 102, 0.5);
            backdrop-filter: blur(5px);
        }

        .bottom-area {
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 60%, transparent 100%);
            padding: 0 20px max(20px, env(safe-area-inset-bottom));
        }
        .progress-container { width: 100%; height: 30px; display: flex; align-items: center; cursor: pointer; position: relative; }
        .progress-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; position: absolute; width: 100%; }
        .progress-buffer { width: 0%; height: 4px; background: rgba(255,255,255,0.5); border-radius: 2px; position: absolute; left: 0; transition: width 0.2s; }
        .progress-fill { height: 4px; width: 0%; background: #ff3366; border-radius: 2px; position: absolute; left: 0; z-index: 2; }
        .progress-fill::after { 
            content: ''; position: absolute; right: -6px; top: -4px; width: 12px; height: 12px; 
            background: white; border-radius: 50%; transform: scale(0); transition: transform 0.2s; box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .ui-layer:not(.hidden-ui) .progress-fill::after { transform: scale(1); }

        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .left-controls { display: flex; align-items: center; gap: 20px; }
        .right-controls { display: flex; align-items: center; gap: 25px; }

        .time-text { font-family: monospace; font-size: 0.9rem; font-weight: 600; color: #ddd; text-shadow: 0 1px 2px black; }

        /* --- MENÚ AJUSTES (DRAWER) --- */
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 70; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .drawer-overlay.open { opacity: 1; pointer-events: auto; }
        
        .drawer { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a;
            border-radius: 20px 20px 0 0; z-index: 75; transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); padding-bottom: max(20px, env(safe-area-inset-bottom));
            max-height: 70vh; display: flex; flex-direction: column; color: white;
        }
        .drawer.open { transform: translateY(0); }
        .drawer-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
        
        .menu-list { padding: 10px 0; overflow-y: auto; }
        .menu-item { 
            padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; 
            font-size: 1rem; cursor: pointer; border-bottom: 1px solid #2a2a2a; 
        }
        .menu-item:active { background: #333; }
        .menu-item i { margin-right: 15px; width: 20px; text-align: center; color: #aaa; }
        .menu-value { color: #ff3366; font-weight: 600; font-size: 0.9rem; }

        /* Submenús Grid */
        .submenu { display: none; padding: 20px; }
        .submenu.active { display: block; }
        .grid-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .option-btn { background: #333; padding: 15px; border-radius: 12px; text-align: center; font-size: 0.9rem; font-weight: 600; cursor: pointer; }
        .option-btn.active { background: #ff3366; color: white; }
        
        /* Grid especial para calidad (más ancho) */
        .grid-quality { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        .ep-list { overflow-y: auto; padding: 10px 20px; max-height: 50vh; }
        .ep-item { padding: 15px; margin-bottom: 8px; border-radius: 10px; background: #252525; display: flex; gap: 15px; cursor: pointer; align-items: center; }
        .ep-item.active { border: 1px solid #ff3366; background: #2a1a1a; }
        .ep-num { color: #ff3366; font-weight: 900; font-size: 1.2rem; }

        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: #ff3366; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; position: absolute; z-index: 5; display: none; pointer-events: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .center-play-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5rem; color: rgba(255,255,255,0.8); pointer-events: none; opacity: 0; transition: transform 0.2s, opacity 0.2s; z-index: 30;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }
        .show-play .center-play-icon { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; cursor: pointer; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="brightness-overlay"></div>

    <div class="video-container" id="mainContainer" onmousemove="resetUiTimer()">
        <video id="html5-player" class="hidden" playsinline></video>
        <div id="yt-placeholder"></div>
        <div id="spinner" class="spinner"></div>

        <div id="centerFeedback" class="center-feedback">
            <i id="feedIcon" class="fa-solid fa-volume-high feedback-icon"></i>
            <div id="feedText" class="feedback-text">100%</div>
        </div>
        
        <div id="bigPlay" class="center-play-icon" onclick="togglePlay()"><i class="fa-solid fa-play"></i></div>

        <div id="seekLeft" class="seek-layer left">
            <div class="seek-icon-group">
                <i class="fa-solid fa-backward pulse-anim"></i>
                <i class="fa-solid fa-backward pulse-anim" style="opacity:0.5; font-size: 0.7em;"></i>
            </div>
            <div id="seekLeftText" class="seek-text">10s</div>
        </div>

        <div id="seekRight" class="seek-layer right">
            <div class="seek-icon-group">
                <i class="fa-solid fa-forward pulse-anim" style="opacity:0.5; font-size: 0.7em;"></i>
                <i class="fa-solid fa-forward pulse-anim"></i>
            </div>
            <div id="seekRightText" class="seek-text">10s</div>
        </div>

        <div id="gestureLayer"></div>

        <div id="unlockBtn" onclick="toggleLock()">
            <i class="fa-solid fa-lock-open"></i> DESBLOQUEAR
        </div>

        <div id="uiLayer" class="ui-layer">
            <div class="top-bar">
                <i class="fa-solid fa-arrow-left icon-btn" onclick="goBack()" style="font-size:1.4rem;"></i>
                
                <div class="video-info">
                    <div class="video-title">
                        <span id="ui-title">Cargando...</span>
                        <span class="quality-badge" id="qualityBadge">HD</span>
                    </div>
                    <div id="ui-subtitle" class="video-subtitle">Flechazo TV</div>
                </div>

                <div class="top-icons">
                    <i class="fa-solid fa-clone icon-btn" onclick="togglePiP()" title="PiP"></i>
                    <i class="fa-solid fa-gear icon-btn" onclick="openSettings()" title="Ajustes"></i>
                    <i class="fa-solid fa-lock icon-btn" onclick="toggleLock()" title="Bloquear"></i>
                </div>
            </div>

            <div class="sidebar">
                <div class="side-circle" onclick="toggleDrawer('eps')" id="btnEpList" style="display:none; width:50px; height:50px; border-radius:50%; background:rgba(30,30,30,0.8); border:1px solid rgba(255,255,255,0.2); align-items:center; justify-content:center; box-shadow:0 4px 10px black; cursor:pointer;">
                    <i class="fa-solid fa-layer-group" style="color:white; font-size:1.2rem;"></i>
                </div>
            </div>

            <div id="skipIntroBtn" class="skip-intro" onclick="skipIntro()">
                <span>Saltar Intro</span> <i class="fa-solid fa-forward"></i>
            </div>
            
            <div class="bottom-area">
                <div class="progress-container" onclick="handleSeekClick(event)">
                    <div class="progress-bg"></div>
                    <div id="progBuffer" class="progress-buffer"></div> 
                    <div id="progFill" class="progress-fill"></div>
                </div>
                
                <div class="controls-row">
                    <div class="left-controls">
                        <i id="bottomPlayBtn" class="fa-solid fa-play icon-btn" onclick="togglePlay()" style="font-size:1.5rem;"></i>
                        <div class="time-text" id="timeDisplay">00:00 / 00:00</div>
                    </div>
                    
                    <div class="right-controls">
                        <i id="fitBtn" class="fa-solid fa-crop-simple icon-btn" onclick="toggleFit()" title="Ajustar Pantalla"></i>
                        <i class="fa-solid fa-expand icon-btn" onclick="toggleFS()" style="font-size:1.4rem;" title="Pantalla Completa"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawers()"></div>

    <div id="drawer-settings" class="drawer">
        <div class="drawer-header">
            <span>Ajustes</span>
            <i class="fa-solid fa-xmark" onclick="closeDrawers()"></i>
        </div>
        
        <div class="menu-list" id="mainMenu">
            <div class="menu-item" onclick="showSubmenu('speed')">
                <div><i class="fa-solid fa-gauge-high"></i> Velocidad</div>
                <div class="menu-value" id="speedValueLabel">Normal</div>
            </div>
            <div class="menu-item" onclick="showSubmenu('quality')">
                <div><i class="fa-solid fa-sliders"></i> Calidad</div>
                <div class="menu-value" id="qualityValueLabel">Auto</div>
            </div>
            <div class="menu-item">
                <div><i class="fa-solid fa-closed-captioning"></i> Subtítulos</div>
                <div class="menu-value">Desactivado</div>
            </div>
        </div>

        <div class="submenu" id="submenu-speed">
            <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="showMainMenu()">
                <i class="fa-solid fa-arrow-left"></i> <span>Volver</span>
            </div>
            <div class="grid-options">
                <div class="option-btn" onclick="setSpeed(0.5)">0.5x</div>
                <div class="option-btn active" id="sp-1" onclick="setSpeed(1)">1x</div>
                <div class="option-btn" onclick="setSpeed(1.25)">1.25x</div>
                <div class="option-btn" onclick="setSpeed(1.5)">1.5x</div>
                <div class="option-btn" onclick="setSpeed(2)">2.0x</div>
            </div>
        </div>

        <div class="submenu" id="submenu-quality">
            <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="showMainMenu()">
                <i class="fa-solid fa-arrow-left"></i> <span>Volver</span>
            </div>
            <div class="grid-quality">
                <div class="option-btn active" id="qual-auto" onclick="setQuality('default')">Auto</div>
                <div class="option-btn" id="qual-highres" onclick="setQuality('highres')">4K</div>
                <div class="option-btn" id="qual-hd1080" onclick="setQuality('hd1080')">1080p</div>
                <div class="option-btn" id="qual-hd720" onclick="setQuality('hd720')">720p</div>
                <div class="option-btn" id="qual-large" onclick="setQuality('large')">480p</div>
                <div class="option-btn" id="qual-medium" onclick="setQuality('medium')">360p</div>
            </div>
        </div>
    </div>

    <div id="drawer-eps" class="drawer">
        <div class="drawer-header">
            <span>Episodios</span>
            <i class="fa-solid fa-xmark" onclick="closeDrawers()"></i>
        </div>
        <div id="epList" class="ep-list"></div>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let playerType = 'none';
        let ytPlayer = null;
        let html5Player = document.getElementById('html5-player');
        let itemData = null;
        let currentEp = 0;
        let isSerie = false;
        let isPlayingIntro = false;
        let isLocked = false;
        let uiTimeout = null;
        let currentSpeed = 1;
        let currentVol = 1;
        let currentBright = 1;
        let isZoomed = false;

        let touchStartY = 0;
        let activeGesture = null;
        let seekAccumulator = 0;
        let seekOverlayTimer = null;
        let lastTapSide = null;

        let sourceQueue = [];
        let currentSourceIndex = 0;
        
        const INTRO_URL = "https://ia601709.us.archive.org/4/items/gemini_generated_video_B83D69A3/gemini_generated_video_B83D69A3.mp4";
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const directUrl = params.get('url');

        // --- INICIO ---
        window.onload = async () => {
            initGestures();
            
            html5Player.onerror = () => { if(isPlayingIntro) { handleHtml5Ended(); return; } tryNextSource(); };
            html5Player.onended = handleHtml5Ended;

            if (directUrl) {
                try {
                    document.getElementById('ui-title').innerText = "Cargando...";
                    const res = await fetch(`/api/youtube/video?url=${encodeURIComponent(directUrl)}`);
                    if (!res.ok) throw new Error("API YT Error");
                    itemData = await res.json();
                    document.getElementById('ui-title').innerText = itemData.title || "Video";
                    document.getElementById('ui-subtitle').innerText = "YouTube • " + (itemData.cat || "Stream");
                    document.getElementById('qualityBadge').innerText = "YT";
                    if(itemData.imagenes && itemData.imagenes.banner) html5Player.poster = itemData.imagenes.banner;
                    buildSourceQueue(itemData);
                    startPlaybackSequence();
                } catch (e) { console.error("YT Error:", e); alert("Error cargando video"); }
                return;
            } 

            if (id) {
                try {
                    const res = await fetch(`/api/movies/${id}`);
                    if (!res.ok) throw new Error("DB Error");
                    itemData = await res.json();
                    if(itemData.tipo === 'serie') {
                        isSerie = true; document.getElementById('btnEpList').style.display = 'flex'; prepareEp(0);
                    } else {
                        document.getElementById('ui-title').innerText = itemData.title;
                        if(itemData.imagenes && itemData.imagenes.banner) html5Player.poster = itemData.imagenes.banner;
                        buildSourceQueue(itemData); startPlaybackSequence();
                    }
                } catch(e) { console.error(e); }
                return;
            }

            document.getElementById('ui-title').innerText = "Flechazo Demo";
            sourceQueue = ["https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4"];
            startPlaybackSequence();
        };

        // --- FUNCIONES PREMIUM ---
        async function togglePiP() {
            if (playerType === 'html5' && html5Player) {
                try { if (document.pictureInPictureElement) await document.exitPictureInPicture(); else await html5Player.requestPictureInPicture(); } 
                catch (err) { showFeedback('fa-circle-exclamation', 'No Soportado'); }
            } else { showFeedback('fa-youtube', 'Usar App YT'); }
        }

        function toggleFit() {
            isZoomed = !isZoomed;
            const container = document.getElementById('mainContainer');
            const icon = document.getElementById('fitBtn');
            if(isZoomed) { container.classList.add('video-zoomed'); icon.className = "fa-solid fa-compress icon-btn"; showFeedback('fa-crop-simple', 'Llenar'); } 
            else { container.classList.remove('video-zoomed'); icon.className = "fa-solid fa-crop-simple icon-btn"; showFeedback('fa-image', 'Normal'); }
        }

        // --- AJUSTES Y CALIDAD ---
        function openSettings() { if(isLocked) return; toggleDrawer('settings'); showMainMenu(); }
        function showMainMenu() {
            document.getElementById('mainMenu').style.display = 'block';
            document.querySelectorAll('.submenu').forEach(el => el.classList.remove('active'));
        }
        function showSubmenu(id) {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('submenu-'+id).classList.add('active');
        }

        function setQuality(level) {
            // Actualizar UI
            document.querySelectorAll('.grid-quality .option-btn').forEach(btn => btn.classList.remove('active'));
            // Seleccionar el botón clickeado o el correspondiente (truco simple)
            const btnId = 'qual-' + (level === 'default' ? 'auto' : level);
            const btn = document.getElementById(btnId);
            if(btn) btn.classList.add('active');

            // Actualizar Texto Menu
            const label = btn ? btn.innerText : 'Auto';
            document.getElementById('qualityValueLabel').innerText = label;

            // Aplicar lógica real
            if(playerType === 'youtube' && ytPlayer && ytPlayer.setPlaybackQuality) {
                ytPlayer.setPlaybackQuality(level);
                showFeedback('fa-sliders', 'Calidad: ' + label);
            } else {
                showFeedback('fa-circle-info', 'Auto (HTML5)');
            }
            showMainMenu();
        }

        function setSpeed(rate) {
            currentSpeed = rate;
            if(html5Player) html5Player.playbackRate = rate;
            if(ytPlayer) ytPlayer.setPlaybackRate(rate);
            document.querySelectorAll('.grid-options .option-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('speedValueLabel').innerText = rate + 'x';
            showMainMenu();
        }

        // --- GESTOS Y PLAYER LOGIC --- (Igual que antes)
        function initGestures() {
            const layer = document.getElementById('gestureLayer');
            layer.addEventListener('click', (e) => {
                if(isLocked) { animateLockBtn(); return; }
                const w = window.innerWidth; const x = e.clientX;
                if(x < w * 0.30) performSmartSeek(-10, 'left');
                else if(x > w * 0.70) performSmartSeek(10, 'right');
                else { const ui = document.getElementById('uiLayer'); ui.classList.contains('hidden-ui') ? resetUiTimer() : togglePlay(); }
            });
            layer.addEventListener('touchstart', (e) => {
                if(isLocked) return; resetUiTimer();
                touchStartY = e.touches[0].clientY;
                const x = e.touches[0].clientX; const w = window.innerWidth;
                if(x < w/2) activeGesture = 'bright'; else activeGesture = 'vol';
            });
            layer.addEventListener('touchmove', (e) => {
                if(isLocked || !activeGesture) return;
                if (e.cancelable) e.preventDefault(); resetUiTimer();
                const y = e.touches[0].clientY; const delta = touchStartY - y;
                if(Math.abs(delta) > 5) {
                    const step = (delta / window.innerHeight) * 2;
                    if(activeGesture === 'vol') setVolume(currentVol + step);
                    if(activeGesture === 'bright') setBrightness(currentBright + step);
                    touchStartY = y;
                }
            });
            layer.addEventListener('touchend', () => {
                activeGesture = null;
                setTimeout(() => document.getElementById('centerFeedback').classList.remove('visible'), 500);
            });
        }

        function performSmartSeek(seconds, side) {
            if (lastTapSide !== side) { seekAccumulator = 0; lastTapSide = side; document.getElementById('seekLeft').classList.remove('visible'); document.getElementById('seekRight').classList.remove('visible'); }
            clearTimeout(seekOverlayTimer); seekAccumulator += seconds;
            if(playerType === 'html5') html5Player.currentTime += seconds;
            else if(playerType === 'youtube' && ytPlayer) ytPlayer.seekTo(ytPlayer.getCurrentTime() + seconds, true);
            const overlayId = side === 'left' ? 'seekLeft' : 'seekRight';
            const textId = side === 'left' ? 'seekLeftText' : 'seekRightText';
            document.getElementById(textId).innerText = Math.abs(seekAccumulator) + "s";
            document.getElementById(overlayId).classList.add('visible');
            seekOverlayTimer = setTimeout(() => { document.getElementById(overlayId).classList.remove('visible'); seekAccumulator = 0; lastTapSide = null; }, 800);
            resetUiTimer();
        }

        function buildSourceQueue(data) {
            sourceQueue = [];
            if(data.url) sourceQueue.push(data.url);
            if(data.backupUrl) sourceQueue.push(data.backupUrl);
            if(data.mirrors) sourceQueue = sourceQueue.concat(data.mirrors);
            if(sourceQueue.length === 0) sourceQueue.push("");
        }
        function tryNextSource() { currentSourceIndex++; if(currentSourceIndex < sourceQueue.length) loadMainVideo(sourceQueue[currentSourceIndex]); }
        function startPlaybackSequence() { currentSourceIndex = 0; playIntro(); }
        function playIntro() {
            isPlayingIntro = true; playerType = 'intro';
            html5Player.classList.remove('hidden'); document.getElementById('yt-placeholder').classList.add('hidden');
            html5Player.src = INTRO_URL; html5Player.muted = true; updateBottomIcon(true);
            html5Player.play().catch(() => { document.getElementById('bigPlay').classList.add('show-play'); updateBottomIcon(false); });
        }
        function handleHtml5Ended() {
            if(isPlayingIntro) { isPlayingIntro = false; html5Player.muted = false; if(sourceQueue.length > 0) loadMainVideo(sourceQueue[0]); } 
            else if(isSerie) nextEp();
        }

        function loadMainVideo(url) {
            document.getElementById('spinner').style.display = 'block';
            const storageKey = id ? `flechazo_time_${id}_${currentEp}` : `flechazo_time_yt_${url}`;
            const savedTime = localStorage.getItem(storageKey) || 0;
            const ytId = getYouTubeId(url);
            
            if (ytId) {
                playerType = 'youtube';
                html5Player.classList.add('hidden'); html5Player.pause();
                initYouTubePlayer(ytId, parseFloat(savedTime));
            } else {
                playerType = 'html5';
                if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
                document.getElementById('yt-placeholder').classList.add('hidden'); html5Player.classList.remove('hidden');
                html5Player.src = url; html5Player.currentTime = parseFloat(savedTime);
                html5Player.playbackRate = currentSpeed; html5Player.muted = false;
                html5Player.play().catch(e=>console.log(e)); updateBottomIcon(true);
                html5Player.onplaying = () => { document.getElementById('spinner').style.display = 'none'; resetUiTimer(); updateBottomIcon(true); };
                html5Player.onpause = () => updateBottomIcon(false);
                html5Player.onwaiting = () => document.getElementById('spinner').style.display = 'block';
                html5Player.ontimeupdate = updateProgressLoop;
            }
        }

        function setVolume(val) {
            currentVol = Math.max(0, Math.min(1, val));
            if(html5Player) { html5Player.volume = currentVol; if(val>0) html5Player.muted=false; }
            if(ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(currentVol * 100);
            let icon = currentVol > 0.5 ? 'fa-volume-high' : (currentVol===0 ? 'fa-volume-xmark' : 'fa-volume-low');
            showFeedback(icon, Math.round(currentVol * 100) + '%');
        }
        function setBrightness(val) {
            currentBright = Math.max(0.2, Math.min(1, val));
            document.getElementById('brightness-overlay').style.opacity = (1 - currentBright);
            showFeedback('fa-sun', Math.round(currentBright * 100) + '%');
        }
        function showFeedback(iconClass, text) {
            document.getElementById('feedIcon').className = `fa-solid ${iconClass} feedback-icon`;
            document.getElementById('feedText').innerText = text;
            document.getElementById('centerFeedback').classList.add('visible');
        }
        function toggleLock() {
            isLocked = !isLocked;
            const ui = document.getElementById('uiLayer'); const lockBtn = document.getElementById('unlockBtn'); const container = document.getElementById('mainContainer');
            if(isLocked) { ui.classList.add('hidden-ui'); container.classList.add('hide-cursor'); lockBtn.style.display = 'flex'; showFeedback('fa-lock', 'Bloqueado'); } 
            else { lockBtn.style.display = 'none'; resetUiTimer(); showFeedback('fa-lock-open', 'Desbloqueado'); }
            setTimeout(() => document.getElementById('centerFeedback').classList.remove('visible'), 1000);
        }
        function resetUiTimer() {
            if(isLocked) return;
            const ui = document.getElementById('uiLayer'); const container = document.getElementById('mainContainer');
            ui.classList.remove('hidden-ui'); container.classList.remove('hide-cursor');
            clearTimeout(uiTimeout);
            const isPlaying = (playerType === 'html5' && !html5Player.paused && !html5Player.ended) || (playerType === 'youtube' && ytPlayer && ytPlayer.getPlayerState() === 1);
            if(isPlaying) { uiTimeout = setTimeout(() => { ui.classList.add('hidden-ui'); container.classList.add('hide-cursor'); closeDrawers(); }, 3500); }
        }
        function togglePlay() {
            if(isLocked) return;
            const bigPlay = document.getElementById('bigPlay');
            if(playerType === 'html5') {
                if(html5Player.paused) { html5Player.play(); bigPlay.classList.remove('show-play'); updateBottomIcon(true); resetUiTimer(); } 
                else { html5Player.pause(); bigPlay.classList.add('show-play'); updateBottomIcon(false); resetUiTimer(); }
            } else if(playerType === 'youtube' && ytPlayer) {
                if(ytPlayer.getPlayerState() === 1) { ytPlayer.pauseVideo(); bigPlay.classList.add('show-play'); updateBottomIcon(false); } 
                else { ytPlayer.playVideo(); bigPlay.classList.remove('show-play'); updateBottomIcon(true); }
            }
        }
        function updateBottomIcon(isPlaying) { document.getElementById('bottomPlayBtn').className = isPlaying ? "fa-solid fa-pause icon-btn" : "fa-solid fa-play icon-btn"; }
        function updateProgressLoop() {
            if(isPlayingIntro) return;
            let cur = 0, dur = 0, buff = 0;
            if(playerType === 'html5') { cur = html5Player.currentTime; dur = html5Player.duration; if (html5Player.buffered.length > 0) buff = html5Player.buffered.end(html5Player.buffered.length - 1); } 
            else if(ytPlayer && ytPlayer.getCurrentTime) { cur = ytPlayer.getCurrentTime(); dur = ytPlayer.getDuration(); buff = ytPlayer.getVideoLoadedFraction() * dur; }
            if(dur > 0) {
                document.getElementById('progFill').style.width = (cur/dur)*100 + '%'; document.getElementById('progBuffer').style.width = (buff/dur)*100 + '%';
                document.getElementById('timeDisplay').innerText = formatTime(cur) + " / " + formatTime(dur);
                checkSkipIntro(cur);
                const storageKey = id ? `flechazo_time_${id}_${currentEp}` : `flechazo_time_yt_${sourceQueue[0]}`;
                if(Math.floor(cur)%5 === 0) localStorage.setItem(storageKey, cur);
            }
        }
        function handleSeekClick(e) { if(isLocked) return; const rect = e.currentTarget.getBoundingClientRect(); const pct = (e.clientX - rect.left) / rect.width; if(playerType === 'html5' && html5Player.duration) html5Player.currentTime = html5Player.duration * pct; else if(ytPlayer) ytPlayer.seekTo(ytPlayer.getDuration() * pct, true); }
        function formatTime(s) { if(!s || isNaN(s)) return "00:00"; const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec<10?'0'+sec:sec}`; }
        function checkSkipIntro(cur) { const btn = document.getElementById('skipIntroBtn'); if(cur > 10 && cur < 90) btn.classList.add('visible'); else btn.classList.remove('visible'); }
        function skipIntro() { performSmartSeek(85, 'right'); showFeedback('fa-forward-step', 'Intro Saltada'); }
        function animateLockBtn() { const btn = document.getElementById('unlockBtn'); btn.style.transform = "translateX(-50%) scale(1.1)"; setTimeout(() => btn.style.transform = "translateX(-50%) scale(1)", 200); }
        function toggleDrawer(id) { if(isLocked) return; closeDrawers(); document.getElementById('drawer-'+id).classList.add('open'); document.getElementById('drawerOverlay').classList.add('open'); if(id === 'eps') renderEpList(); }
        function closeDrawers() { document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open')); document.getElementById('drawerOverlay').classList.remove('open'); resetUiTimer(); }
        function renderEpList() { const list = document.getElementById('epList'); list.innerHTML = ''; itemData.episodios.forEach((ep, i) => { const div = document.createElement('div'); div.className = `ep-item ${i===currentEp ? 'active' : ''}`; div.innerHTML = `<div class="ep-num">${ep.numero}</div><div>${ep.titulo || 'Episodio '+ep.numero}</div>`; div.onclick = () => { prepareEp(i); closeDrawers(); }; list.appendChild(div); }); }
        function prepareEp(i) { if(!itemData.episodios[i]) return; currentEp = i; document.getElementById('ui-title').innerText = `Episodio ${itemData.episodios[i].numero}`; buildSourceQueue(itemData.episodios[i]); startPlaybackSequence(); }
        function nextEp() { if(isSerie && currentEp+1 < itemData.episodios.length) prepareEp(currentEp+1); }
        function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else if(document.exitFullscreen) document.exitFullscreen(); }
        function goBack() { window.history.back(); }

        function getYouTubeId(url) { if (!url) return null; const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); return (m && m[2].length === 11) ? m[2] : null; }
        function initYouTubePlayer(videoId, start) {
            if (!window.YT || !window.YT.Player) { setTimeout(() => initYouTubePlayer(videoId, start), 100); return; }
            if (ytPlayer) { document.getElementById('yt-placeholder').classList.remove('hidden'); ytPlayer.loadVideoById(videoId, start); return; }
            ytPlayer = new YT.Player('yt-placeholder', {
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'start': Math.floor(start), 'playsinline': 1, 'fs': 0, 'modestbranding': 1 },
                events: { 'onReady': (e)=>{e.target.setPlaybackRate(currentSpeed); e.target.playVideo(); setInterval(updateProgressLoop, 500);}, 
                'onStateChange': (e)=>{ if(e.data===YT.PlayerState.PLAYING){ document.getElementById('spinner').style.display='none'; resetUiTimer(); updateBottomIcon(true); } if(e.data===YT.PlayerState.PAUSED){ document.getElementById('bigPlay').classList.add('show-play'); updateBottomIcon(false); } if(e.data===YT.PlayerState.ENDED && isSerie) nextEp(); } }
            });
            document.getElementById('yt-placeholder').classList.remove('hidden');
        }
    </script>
</body>
</html>
