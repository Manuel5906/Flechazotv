<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Flechazo TV - V6 GOD MODE</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root { 
            --bg: #0f0f1a; --card: #1e1e2d; --primary: #E50914; --text: #fff; --subtext: #aaa;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
            --glass: rgba(30, 30, 40, 0.7); --glass-border: rgba(255, 255, 255, 0.08);
        }
        
        /* TEMAS DINÁMICOS */
        body.theme-blue { --bg: #050a14; --card: #0f1a24; --primary: #0099ff; }
        body.theme-emerald { --bg: #05140a; --card: #0f2415; --primary: #00e676; }
        body.theme-purple { --bg: #140514; --card: #240f24; --primary: #d500f9; }
        body.theme-gold { --bg: #141005; --card: #241e0f; --primary: #ffd700; }
        body.kids-mode { --bg: #ffffff; --card: #f0f0f0; --primary: #FF9800; --text: #111; --subtext: #555; }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: calc(90px + var(--safe-bottom)); overflow-x: hidden; transition: background 0.4s ease; }

        /* --- 2. COMPONENTES UI --- */
        /* Splash Screen */
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .logo-anim { font-size: 36px; font-weight: 900; color: var(--primary); letter-spacing: -1px; animation: heartbeat 1.5s infinite; }
        
        /* Header Glass */
        .header { position: sticky; top: 0; padding: calc(10px + var(--safe-top)) 20px 10px; background: rgba(15,15,26,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); transition: 0.3s; }
        .logo { color: var(--primary); font-weight: 900; font-size: 22px; text-transform: uppercase; }

        /* Navigation Bar */
        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(15,15,26,0.9); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around; padding: 10px 0 calc(10px + var(--safe-bottom)); z-index: 2000; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        .nav-item { color: var(--subtext); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); font-weight: bold; }
        .nav-item i { font-size: 20px; }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9500; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(10px); color: #fff; padding: 14px 18px; border-radius: 50px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; animation: slideDown 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        
        /* Skeleton Loading */
        .skeleton { background: linear-gradient(90deg, #222 25%, #2a2a2a 50%, #222 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }

        /* --- 3. PANTALLAS Y SECCIONES --- */
        .screen { display: none; animation: fadeIn 0.4s; padding-bottom: 20px; }
        .screen.active { display: block; }
        
        .section { margin-top: 35px; }
        .sec-head { padding: 0 20px 12px; display: flex; justify-content: space-between; align-items: flex-end; }
        .sec-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .h-list { display: flex; overflow-x: auto; gap: 14px; padding: 0 20px; scrollbar-width: none; }

        /* --- 4. CARDS & HERO --- */
        /* Hero */
        .hero-wrap { height: 68vh; position: relative; display: flex; align-items: flex-end; margin-top: -65px; }
        .hero-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; mask-image: linear-gradient(to bottom, black 70%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%); }
        .hero-content { padding: 20px; z-index: 2; width: 100%; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .hero-title { font-size: 42px; font-weight: 900; line-height: 0.9; margin: 10px 0; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; height: 44px; border-radius: 8px; border: none; font-weight: 700; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-play { background: #fff; color: #000; }
        .btn-blur { background: rgba(255,255,255,0.2); color: #fff; backdrop-filter: blur(10px); }

        /* Cards */
        .card { width: 115px; flex-shrink: 0; position: relative; cursor: pointer; transition: transform 0.2s; }
        .card:active { transform: scale(0.95); }
        .card-img { width: 100%; height: 165px; border-radius: 8px; object-fit: cover; background: #222; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* Wide Card (Continue) */
        .wide-card { width: 220px; flex-shrink: 0; position: relative; cursor: pointer; }
        .wide-img-box { position: relative; height: 125px; border-radius: 8px; overflow: hidden; }
        .wide-img { width: 100%; height: 100%; object-fit: cover; }
        .progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.3); }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; }
        .delete-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; backdrop-filter: blur(4px); z-index: 5; }

        /* --- 5. INTERACTIVE MODULES --- */
        /* Profile Gate */
        #gate { position: fixed; inset: 0; background: var(--bg); z-index: 8000; display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s; }
        .gate-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-top: 30px; }
        .profile-icon { width: 100px; height: 100px; border-radius: 12px; object-fit: cover; border: 2px solid transparent; transition: 0.2s; }
        .profile-item:active .profile-icon { border-color: var(--text); transform: scale(0.95); }

        /* Bottom Sheet */
        #sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6000; display: none; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }
        #sheet-overlay.visible { opacity: 1; }
        .sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: #15151e; border-radius: 24px 24px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 85vh; overflow-y: auto; }
        #sheet-overlay.visible .sheet { transform: translateY(0); }
        .sheet-hero { height: 220px; position: relative; }
        .sheet-img { width: 100%; height: 100%; object-fit: cover; mask-image: linear-gradient(to bottom, black 60%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%); }
        .sheet-body { padding: 20px; margin-top: -60px; position: relative; z-index: 2; }

        /* Player */
        #player { position: fixed; inset: 0; background: #000; z-index: 7000; display: none; justify-content: center; align-items: center; }
        .close-player { position: absolute; top: 30px; left: 20px; font-size: 26px; color: #fff; z-index: 7001; filter: drop-shadow(0 2px 4px #000); cursor: pointer; }
        #video-wrap { width: 100%; height: 100%; }
        iframe, video { width: 100%; height: 100%; border: none; }

        /* Shorts */
        .shorts-feed { height: calc(100vh - 80px); overflow-y: scroll; scroll-snap-type: y mandatory; background: #000; }
        .short { height: 100%; width: 100%; scroll-snap-align: start; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        .short-vid { width: 100%; height: 100%; object-fit: cover; }
        .short-ui { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .s-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; backdrop-filter: blur(5px); color: #fff; }

        /* --- 6. SETTINGS & TOGGLES --- */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .vip-card { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); padding: 20px; border-radius: 16px; color: #000; margin: 20px; position: relative; overflow: hidden; box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2); }
        .vip-card::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(transparent, rgba(255,255,255,0.4), transparent); transform: rotate(45deg); animation: shine 3s infinite; }

        /* ANIMATIONS */
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes shine { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="splash">
        <div class="logo-anim">FLECHAZO TV</div>
        <div style="margin-top:20px; color:#666; font-size:12px; font-weight:600;">CARGANDO V6.0 GOD MODE</div>
        <div class="spinner" style="border-top-color:var(--primary); margin-top:20px;"></div>
    </div>

    <div id="gate">
        <div style="font-size:20px; font-weight:bold; margin-bottom:10px;">¿Quién eres?</div>
        <div class="gate-grid" id="gate-grid"></div>
        <button onclick="alert('Crea un nuevo perfil')" style="margin-top:40px; background:none; border:1px solid #555; padding:10px 20px; color:#aaa; border-radius:20px;">+ Añadir Perfil</button>
    </div>

    <div id="toast-container"></div>

    <div id="player">
        <i class="fa-solid fa-chevron-left close-player" onclick="closePlayer()"></i>
        <div id="video-wrap"></div>
    </div>

    <div id="sheet-overlay" onclick="if(event.target===this) toggleSheet(false)">
        <div class="sheet">
            <div id="sheet-content"></div>
        </div>
    </div>

    <div id="app" class="hidden">
        
        <div id="tab-home" class="screen active">
            <header class="header">
                <div class="logo">Flechazo TV</div>
                <div onclick="showToast('Sin notificaciones', 'bell')" style="width:36px; height:36px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <i class="fa-regular fa-bell"></i>
                </div>
            </header>

            <div id="hero">
                <div class="skeleton" style="height:60vh; margin-bottom:20px;"></div>
            </div>

            <div id="sec-continue" class="section hidden">
                <div class="sec-head"><span class="sec-title">Continuar Viendo</span></div>
                <div class="h-list" id="list-continue"></div>
            </div>

            <div class="section">
                <div class="sec-head"><span class="sec-title">Top 10 en Perú</span></div>
                <div class="h-list" id="list-top10"></div>
            </div>

            <div class="section">
                <div class="sec-head"><span class="sec-title">Tendencias</span></div>
                <div class="h-list" id="list-trends"></div>
            </div>
        </div>

        <div id="tab-explore" class="screen">
            <div style="padding:15px 20px; position:sticky; top:0; z-index:90; background:var(--bg);">
                <div style="background:rgba(255,255,255,0.08); border-radius:12px; padding:12px; display:flex; gap:10px; align-items:center;">
                    <i class="fa-solid fa-magnifying-glass" style="color:#777;"></i>
                    <input type="text" placeholder="Títulos, personas o géneros" style="background:none; border:none; color:#fff; width:100%; font-size:16px;" onkeyup="runSearch(this.value)">
                </div>
            </div>
            <div id="search-grid" style="padding:0 20px; display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;"></div>
        </div>

        <div id="tab-shorts" class="screen" style="padding:0;">
            <div class="shorts-feed" id="shorts-feed"></div>
        </div>

        <div id="tab-profile" class="screen">
            <div style="text-align:center; padding:40px 20px 0;">
                <img id="p-avatar" class="profile-icon" style="width:100px; height:100px; border-color:var(--primary);">
                <h2 id="p-name" style="margin:10px 0 5px;">Usuario</h2>
                <div id="p-plan" style="color:var(--subtext); font-size:13px;">Plan Estándar</div>

                <div style="display:flex; justify-content:center; gap:20px; margin:25px 0;">
                    <div style="background:var(--card); padding:15px; border-radius:10px; min-width:90px;">
                        <div id="st-watched" style="font-weight:900; font-size:18px;">0</div>
                        <div style="font-size:11px; color:#aaa;">Vistos</div>
                    </div>
                    <div style="background:var(--card); padding:15px; border-radius:10px; min-width:90px;">
                        <div id="st-list" style="font-weight:900; font-size:18px;">0</div>
                        <div style="font-size:11px; color:#aaa;">Mi Lista</div>
                    </div>
                </div>
            </div>

            <div id="vip-card" class="vip-card hidden">
                <div style="font-weight:900; font-size:20px;">VIP ULTIMATE</div>
                <div style="font-size:12px; opacity:0.8;">Acceso total • 4K HDR • Sin Anuncios</div>
            </div>

            <h4 style="margin:20px 20px 10px; color:var(--subtext); font-size:12px;">AJUSTES</h4>
            <div style="background:var(--card); margin:0 20px; border-radius:12px;">
                <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center;">
                    <span><i class="fa-solid fa-child" style="width:25px;"></i> Modo Niños</span>
                    <label class="switch"><input type="checkbox" onchange="toggleKidsMode(this.checked)"><span class="slider round"></span></label>
                </div>
                <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center;">
                    <span><i class="fa-solid fa-download" style="width:25px;"></i> Solo Wi-Fi</span>
                    <label class="switch"><input type="checkbox" checked><span class="slider round"></span></label>
                </div>
                <div style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                    <span><i class="fa-solid fa-palette" style="width:25px;"></i> Tema</span>
                    <div style="display:flex; gap:5px;">
                        <div onclick="setTheme('')" style="width:20px; height:20px; background:#E50914; border-radius:50%;"></div>
                        <div onclick="setTheme('blue')" style="width:20px; height:20px; background:#0099ff; border-radius:50%;"></div>
                        <div onclick="setTheme('gold')" style="width:20px; height:20px; background:#ffd700; border-radius:50%;"></div>
                    </div>
                </div>
            </div>

            <h4 style="margin:20px 20px 10px; color:var(--subtext); font-size:12px;">CUENTA</h4>
            <div style="background:var(--card); margin:0 20px; border-radius:12px;">
                <div onclick="changeProfile()" style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer;">
                    <i class="fa-solid fa-users" style="width:25px;"></i> Cambiar Perfil
                </div>
                <div onclick="resetApp()" style="padding:15px; cursor:pointer; color:#ff4444;">
                    <i class="fa-solid fa-trash" style="width:25px;"></i> Borrar Datos
                </div>
            </div>
            
            <br><br>
        </div>

    </div>

    <div id="navbar" class="nav hidden">
        <div class="nav-item active" onclick="goTab('home', this)"><i class="fa-solid fa-house"></i>Inicio</div>
        <div class="nav-item" onclick="goTab('explore', this)"><i class="fa-solid fa-compass"></i>Explorar</div>
        <div class="nav-item" onclick="goTab('shorts', this)"><i class="fa-brands fa-tiktok"></i>Shorts</div>
        <div class="nav-item" onclick="goTab('profile', this)"><i class="fa-solid fa-user"></i>Perfil</div>
    </div>

    <script>
        // --- 1. DATA & STATE ---
        const API_URL = 'https://flechazotv.vercel.app/api/movies';
        let moviesDB = [];
        let profiles = [
            { id: 1, name: 'Gamer Pro', type: 'admin', img: 'https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg' },
            { id: 2, name: 'Kids', type: 'kids', img: 'https://i.pinimg.com/564x/4d/9d/3e/4d9d3e8e1784534a621796d1955746f1.jpg' }
        ];
        let currentProfile = null;

        // --- 2. STARTUP ---
        window.onload = async () => {
            // Cargar tema guardado
            const t = localStorage.getItem('f_theme');
            if(t) document.body.className = t;

            // Simular carga API
            try {
                const r = await fetch(API_URL);
                moviesDB = await r.json();
            } catch (e) { console.log('Offline'); }

            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').style.display='none', 500);
                renderGate();
            }, 2000);
        };

        // --- 3. PROFILE GATE ---
        function renderGate() {
            const g = document.getElementById('gate-grid');
            g.innerHTML = profiles.map(p => `
                <div style="text-align:center; cursor:pointer;" onclick="login(${p.id})">
                    <img src="${p.img}" class="profile-icon">
                    <div style="margin-top:8px; color:#ccc;">${p.name}</div>
                </div>
            `).join('');
        }

        function login(id) {
            currentProfile = profiles.find(p => p.id === id);
            
            // Protección de Perfil (Simulada)
            // if(currentProfile.type === 'admin') { let pin = prompt('PIN de Seguridad'); if(pin !== '0000') return alert('Incorrecto'); }

            document.getElementById('gate').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('navbar').classList.remove('hidden');
            
            // Cargar UI
            updateProfileUI();
            if(moviesDB.length) initContent();
        }

        // --- 4. CORE RENDER ---
        function initContent() {
            renderHero(moviesDB[0]);
            renderList('list-trends', moviesDB);
            renderTop10(moviesDB);
            renderSearch(moviesDB);
            renderShorts(moviesDB);
            renderContinue();
        }

        function renderHero(m) {
            document.getElementById('hero').innerHTML = `
                <div class="hero-wrap">
                    <img src="${m.img}" class="hero-bg">
                    <div class="hero-gradient"></div>
                    <div class="hero-content">
                        <div class="hero-tags"><span class="tag">TOP 1</span><span class="tag">HD</span></div>
                        <h1 class="hero-title">${m.title}</h1>
                        <p style="color:#ddd; font-size:13px; margin-bottom:15px; line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">${m.desc}</p>
                        <div class="btn-group">
                            <button class="btn btn-play" onclick="playVideo('${m.videoUrl}', ${m.id})"><i class="fa-solid fa-play"></i> Ver</button>
                            <button class="btn btn-blur" onclick="openSheet(${m.id})"><i class="fa-solid fa-info"></i> Info</button>
                        </div>
                    </div>
                </div>`;
        }

        function renderList(id, list) {
            document.getElementById(id).innerHTML = list.map(m => `
                <div class="card" onclick="openSheet(${m.id})"><img src="${m.img}" class="card-img" loading="lazy"></div>
            `).join('');
        }

        function renderTop10(list) {
            document.getElementById('list-top10').innerHTML = list.slice(0, 10).map((m, i) => `
                <div class="card" style="width:140px; display:flex; align-items:flex-end; margin-left:20px;" onclick="openSheet(${m.id})">
                    <span style="position:absolute; left:-25px; bottom:-5px; font-size:90px; font-weight:900; -webkit-text-stroke:2px #555; color:#000; font-family:impact; line-height:0.8; z-index:-1;">${i+1}</span>
                    <img src="${m.img}" style="width:110px; height:160px; border-radius:6px; object-fit:cover;">
                </div>`).join('');
        }

        // --- 5. BOTTOM SHEET ---
        function openSheet(id) {
            const m = moviesDB.find(x => x.id === id);
            const ov = document.getElementById('sheet-overlay');
            const co = document.getElementById('sheet-content');
            
            // Simular calificación
            const stars = '⭐⭐⭐⭐⭐'.substring(0, Math.floor(Math.random() * 5) + 1);

            co.innerHTML = `
                <div class="sheet-hero">
                    <img src="${m.img}" class="sheet-img">
                    <div style="position:absolute; top:15px; right:15px; width:30px; height:30px; background:rgba(0,0,0,0.5); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff;" onclick="toggleSheet(false)"><i class="fa-solid fa-xmark"></i></div>
                </div>
                <div class="sheet-body">
                    <h2 style="font-size:24px; font-weight:900; margin-bottom:5px;">${m.title}</h2>
                    <div style="display:flex; gap:10px; font-size:12px; color:#aaa; margin-bottom:15px;">
                        <span style="color:#46d369; font-weight:bold;">98% Match</span>
                        <span>2025</span>
                        <span style="border:1px solid #555; padding:0 4px; border-radius:3px;">4K</span>
                        <span>${stars}</span>
                    </div>
                    <p style="color:#ccc; font-size:14px; line-height:1.5; margin-bottom:20px;">${m.desc}</p>
                    
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <button class="btn btn-play" onclick="playVideo('${m.videoUrl}', ${m.id}); toggleSheet(false)">
                            <i class="fa-solid fa-play"></i> Reproducir
                        </button>
                        <button class="btn btn-blur" style="background:#2a2a35;" onclick="showToast('Descargando...','download')">
                            <i class="fa-solid fa-download"></i> Descargar
                        </button>
                        <button class="btn btn-blur" style="background:transparent; border:1px solid #333;" onclick="playVideo('${m.videoUrl}'); toggleSheet(false)">
                            <i class="fa-brands fa-youtube"></i> Ver Trailer
                        </button>
                    </div>

                    <div style="margin-top:25px;">
                        <h4 style="margin-bottom:10px;">Reparto</h4>
                        <div style="display:flex; gap:15px; overflow-x:auto;">
                            ${[1,2,3,4].map(i => `<div style="text-align:center; width:60px; flex-shrink:0;"><img src="https://i.pravatar.cc/100?img=${i}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; margin-bottom:5px;"><div style="font-size:10px; color:#aaa;">Actor ${i}</div></div>`).join('')}
                        </div>
                    </div>
                </div>`;
            
            ov.style.display = 'block';
            setTimeout(() => ov.classList.add('visible'), 10);
        }

        function toggleSheet(show) {
            const ov = document.getElementById('sheet-overlay');
            if(show) {
                ov.style.display = 'block';
                setTimeout(() => ov.classList.add('visible'), 10);
            } else {
                ov.classList.remove('visible');
                setTimeout(() => ov.style.display='none', 300);
            }
        }

        // --- 6. CONTINUE WATCHING ---
        function renderContinue() {
            const hist = JSON.parse(localStorage.getItem('f_hist')) || {};
            const ids = Object.keys(hist).sort((a,b) => hist[b].ts - hist[a].ts);
            const con = document.getElementById('sec-continue');
            
            if(ids.length === 0) { con.classList.add('hidden'); return; }
            con.classList.remove('hidden');

            document.getElementById('list-continue').innerHTML = ids.map(id => {
                const m = moviesDB.find(x => x.id == id);
                if(!m) return '';
                const pct = (hist[id].time / hist[id].dur) * 100 || 0;
                return `
                <div class="wide-card" onclick="playVideo('${m.videoUrl}', ${m.id})">
                    <div class="delete-btn" onclick="event.stopPropagation(); deleteHist(${id})"><i class="fa-solid fa-xmark" style="font-size:12px;"></i></div>
                    <div class="wide-img-box">
                        <img src="${m.img}" class="wide-img">
                        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                        <div class="play-overlay"><div class="play-circle"><i class="fa-solid fa-play" style="color:#fff"></i></div></div>
                    </div>
                    <div class="wide-info"><span>${m.title}</span><span>Continuar</span></div>
                </div>`;
            }).join('');
        }

        function deleteHist(id) {
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            delete h[id];
            localStorage.setItem('f_hist', JSON.stringify(h));
            renderContinue();
            updateProfileUI();
        }

        // --- 7. PLAYER ---
        function playVideo(url, id) {
            const p = document.getElementById('player');
            const c = document.getElementById('video-wrap');
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            c.innerHTML = '';
            
            if(url.includes('youtu')) {
                const v = url.includes('v=') ? url.split('v=')[1] : url.split('/').pop();
                c.innerHTML = `<iframe src="https://www.youtube.com/embed/${v}?autoplay=1&rel=0&modestbranding=1" allowfullscreen></iframe>`;
                if(id) saveHistory(id, 100, 100);
            } else {
                const v = document.createElement('video');
                v.src = url; v.controls = true; v.autoplay = true; v.playsInline = true;
                if(id && h[id]) v.currentTime = h[id].time;
                if(id) v.addEventListener('timeupdate', () => { if(v.currentTime>5) saveHistory(id, v.currentTime, v.duration); });
                c.appendChild(v);
            }
            p.style.display = 'flex';
        }
        function saveHistory(id, t, d) {
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            h[id] = { time: t, dur: d, ts: Date.now() };
            localStorage.setItem('f_hist', JSON.stringify(h));
        }
        function closePlayer() {
            document.getElementById('video-wrap').innerHTML = '';
            document.getElementById('player').style.display = 'none';
            renderContinue();
            updateProfileUI();
        }

        // --- 8. SHORTS & SEARCH ---
        function renderShorts(list) {
            const feed = [...list, ...list];
            document.getElementById('shorts-feed').innerHTML = feed.map(m => `
                <div class="short">
                    <video src="${m.videoUrl}" class="short-vid" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="short-ui">
                        <div class="s-btn" onclick="showToast('Like','heart')"><i class="fa-solid fa-heart"></i></div>
                        <div class="s-btn"><i class="fa-solid fa-comment-dots"></i></div>
                        <div class="s-btn"><i class="fa-solid fa-share"></i></div>
                    </div>
                </div>`).join('');
        }
        function runSearch(v) {
            const g = document.getElementById('search-grid');
            const l = v ? moviesDB.filter(m => m.title.toLowerCase().includes(v.toLowerCase())) : moviesDB;
            g.innerHTML = l.map(m => `<div onclick="openSheet(${m.id})"><img src="${m.img}" style="width:100%;height:150px;border-radius:6px;object-fit:cover;background:#222;"></div>`).join('');
        }
        function renderSearch(l) { runSearch(''); }

        // --- 9. PERFIL & AJUSTES ---
        function updateProfileUI() {
            document.getElementById('p-avatar').src = currentProfile.img;
            document.getElementById('p-name').innerText = currentProfile.name;
            document.getElementById('p-plan').innerText = currentProfile.type === 'admin' ? 'Plan VIP Ultimate' : 'Plan Kids';
            
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            document.getElementById('st-watched').innerText = Object.keys(h).length;
            document.getElementById('st-list').innerText = Math.floor(Math.random()*10); // Simulado

            if(currentProfile.type === 'admin') document.getElementById('vip-card').classList.remove('hidden');
            else document.getElementById('vip-card').classList.add('hidden');
        }

        function toggleKidsMode(on) {
            if(on) document.body.className = 'kids-mode';
            else document.body.className = localStorage.getItem('f_theme') || '';
            showToast(on ? 'Modo Niños Activado' : 'Modo Normal', 'child');
        }
        function setTheme(t) {
            if(t) { document.body.className = 'theme-'+t; localStorage.setItem('f_theme', 'theme-'+t); }
            else { document.body.className = ''; localStorage.setItem('f_theme', ''); }
        }
        function changeProfile() {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('navbar').classList.add('hidden');
            document.getElementById('gate').style.display = 'flex';
        }

        // --- 10. UTILS ---
        function goTab(t, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(t === 'shorts') renderShorts(moviesDB);
        }
        function showToast(msg, icon) {
            const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<i class="fa-solid fa-${icon}"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        function resetApp() { if(confirm('¿Borrar todo?')) { localStorage.clear(); location.reload(); } }

        // Detectar Offline
        window.addEventListener('offline', () => showToast('Sin conexión. Modo Offline', 'wifi'));
        window.addEventListener('online', () => showToast('Conexión restablecida', 'wifi'));

    </script>
</body>
</html>
