<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f0f1a">
    <title>Flechazo TV - MAX</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE CSS --- */
        :root { 
            --bg: #0f0f1a; --card: #1e1e2d; --primary: #E50914; --text: #fff;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        
        /* Temas */
        body.theme-blue { --bg: #0a101a; --card: #15202b; --primary: #0088cc; }
        body.theme-green { --bg: #0a1a10; --card: #152b1d; --primary: #00cc66; }
        body.theme-purple { --bg: #150a1a; --card: #25152b; --primary: #aa00cc; }
        body.theme-gold { --bg: #1a150a; --card: #2b2515; --primary: #cca300; }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: calc(85px + var(--safe-bottom)); overflow-x: hidden; user-select: none; -webkit-font-smoothing: antialiased; }

        /* --- 2. MULTI-PERFIL (NUEVO) --- */
        #profile-gate { position: fixed; inset: 0; background: var(--bg); z-index: 8000; display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s; }
        .gate-title { font-size: 24px; font-weight: 600; margin-bottom: 40px; }
        .gate-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .gate-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; transition: transform 0.2s; }
        .gate-item:active { transform: scale(0.95); }
        .gate-img { width: 100px; height: 100px; border-radius: 8px; border: 2px solid transparent; object-fit: cover; }
        .gate-item.active .gate-img { border-color: var(--text); }
        .gate-name { font-size: 14px; color: #ccc; }
        .gate-add { width: 100px; height: 100px; border-radius: 8px; border: 2px dashed #555; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #555; }

        /* --- 3. UI PRINCIPAL --- */
        .screen { display: none; animation: fadeEffect 0.3s; padding-bottom: 20px; }
        .screen.active { display: block; }
        
        .header { position: sticky; top: 0; padding: calc(10px + var(--safe-top)) 20px 10px; background: rgba(15,15,26,0.95); backdrop-filter: blur(10px); z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { color: var(--primary); font-weight: 900; font-size: 22px; text-transform: uppercase; letter-spacing: -1px; }

        /* HERO */
        .hero-wrap { height: 65vh; position: relative; display: flex; align-items: flex-end; margin-top: -60px; }
        .hero-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; mask-image: linear-gradient(to bottom, black 60%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%); }
        .hero-gradient { position: absolute; inset: 0; background: linear-gradient(to top, var(--bg) 0%, rgba(15,15,26,0.1) 50%, rgba(15,15,26,0.8) 100%); }
        .hero-content { padding: 20px; z-index: 2; width: 100%; }
        .hero-tags { display: flex; gap: 8px; margin-bottom: 8px; }
        .tag { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.1); }
        .hero-title { font-size: 42px; font-weight: 900; line-height: 0.9; margin-bottom: 10px; text-shadow: 0 4px 20px #000; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; height: 42px; border-radius: 8px; border: none; font-weight: 700; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-play { background: #fff; color: #000; }
        .btn-info { background: rgba(255,255,255,0.25); color: #fff; backdrop-filter: blur(10px); }

        /* LISTAS */
        .section { margin-top: 35px; }
        .sec-head { padding: 0 20px 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .sec-title { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .h-list { display: flex; overflow-x: auto; gap: 12px; padding: 0 20px; scrollbar-width: none; }
        
        /* CARD STANDARD */
        .card { width: 115px; flex-shrink: 0; position: relative; cursor: pointer; transition: transform 0.2s; }
        .card:active { transform: scale(0.95); }
        .card-img { width: 100%; height: 165px; border-radius: 8px; object-fit: cover; background: #222; }

        /* CARD ANCHA (CONTINUE) */
        .wide-card { width: 220px; flex-shrink: 0; position: relative; cursor: pointer; }
        .wide-img-box { position: relative; height: 125px; border-radius: 8px; overflow: hidden; }
        .wide-img { width: 100%; height: 100%; object-fit: cover; }
        .play-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
        .play-circle { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.5); border: 2px solid #fff; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .progress-bg { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; }
        .wide-info { margin-top: 6px; display: flex; justify-content: space-between; font-size: 11px; color: #bbb; }
        .delete-btn { position: absolute; top: 6px; right: 6px; width: 26px; height: 26px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; z-index: 10; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2); }

        /* TOP 10 RANKING */
        .rank-card { width: 140px; flex-shrink: 0; position: relative; display: flex; align-items: flex-end; cursor: pointer; margin-left: 20px; }
        .rank-num { position: absolute; left: -25px; bottom: -5px; font-size: 90px; font-weight: 900; color: #000; -webkit-text-stroke: 2px #555; font-family: impact, sans-serif; line-height: 0.8; z-index: -1; }
        .rank-img { width: 110px; height: 160px; border-radius: 6px; object-fit: cover; }

        /* --- 4. DETAILS SHEET (NUEVO) --- */
        #details-sheet { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 6000; display: none; align-items: flex-end; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s; }
        #details-sheet.open { opacity: 1; }
        .sheet-content { background: #181820; width: 100%; max-height: 85vh; border-radius: 20px 20px 0 0; overflow-y: auto; position: relative; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }
        #details-sheet.open .sheet-content { transform: translateY(0); }
        
        .sheet-hero { position: relative; height: 250px; }
        .sheet-img { width: 100%; height: 100%; object-fit: cover; mask-image: linear-gradient(to bottom, black 80%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%); }
        .sheet-close { position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; z-index: 10; }
        
        .sheet-body { padding: 20px; margin-top: -40px; position: relative; z-index: 2; }
        .sheet-title { font-size: 28px; font-weight: 900; margin-bottom: 10px; line-height: 1.1; }
        .sheet-meta { display: flex; gap: 10px; font-size: 12px; color: #aaa; margin-bottom: 15px; align-items: center; }
        .meta-tag { border: 1px solid #555; padding: 2px 4px; border-radius: 3px; font-size: 10px; font-weight: bold; }
        
        .sheet-actions { display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
        .s-btn { width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
        .s-btn-play { background: #fff; color: #000; }
        .s-btn-dl { background: #2a2a35; color: #fff; }
        
        .sheet-desc { color: #ccc; font-size: 14px; line-height: 1.5; margin-bottom: 25px; }
        
        /* Cast & Episodes */
        .cast-row { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: none; }
        .cast-item { text-align: center; flex-shrink: 0; width: 70px; }
        .cast-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #333; margin-bottom: 5px; }
        .cast-name { font-size: 11px; color: #bbb; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .ep-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid #2a2a35; cursor: pointer; }
        .ep-img { width: 100px; height: 60px; border-radius: 6px; object-fit: cover; background: #222; }
        .ep-info h4 { font-size: 14px; margin: 0 0 4px; }
        .ep-info p { font-size: 12px; color: #888; margin: 0; }

        /* --- 5. NOTIFICACIONES (TOAST) --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9000; width: 90%; max-width: 350px; }
        .toast { background: rgba(30,30,40,0.95); backdrop-filter: blur(10px); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; animation: slideDown 0.3s; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .toast i { color: var(--primary); }
        
        /* --- 6. SHORTS & OTHERS --- */
        .shorts-container { height: calc(100vh - 80px); overflow-y: scroll; scroll-snap-type: y mandatory; background: #000; }
        .short-item { height: 100%; width: 100%; scroll-snap-align: start; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        .short-video { width: 100%; height: 100%; object-fit: cover; }
        .short-ui { position: absolute; inset: 0; pointer-events: none; }
        .short-right { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; pointer-events: auto; }
        .s-action { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #fff; font-size: 11px; text-shadow: 0 1px 2px #000; cursor: pointer; }
        .s-icon { width: 45px; height: 45px; background: rgba(0,0,0,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; backdrop-filter: blur(4px); transition: 0.2s; }
        .s-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* --- 7. PLAYER & NAV --- */
        .player-fs { position: fixed; inset: 0; background: #000; z-index: 7000; display: none; align-items: center; justify-content: center; }
        .close-player { position: absolute; top: 30px; left: 20px; font-size: 24px; color: #fff; z-index: 7001; cursor: pointer; filter: drop-shadow(0 0 5px #000); }
        #video-container { width: 100%; height: 100%; }
        iframe, video { width: 100%; height: 100%; border: none; }

        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(15,15,26,0.98); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0 calc(10px + var(--safe-bottom)); z-index: 2000; backdrop-filter: blur(10px); }
        .nav-item { color: #666; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item i { font-size: 20px; }
        
        /* Utils */
        .hidden { display: none !important; }
        .skeleton { background: linear-gradient(90deg, #222 25%, #333 50%, #222 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeEffect { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="splash" style="position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column; transition:0.5s;">
        <div style="font-size:30px; font-weight:900; color:var(--primary); letter-spacing:-1px;">FLECHAZO TV</div>
        <div style="width:30px; height:30px; border:3px solid #333; border-top-color:var(--primary); border-radius:50%; margin-top:20px; animation:spin 1s linear infinite;"></div>
    </div>

    <div id="toast-container"></div>

    <div id="player-fs" class="player-fs">
        <i class="fa-solid fa-chevron-left close-player" onclick="closePlayer()"></i>
        <div id="video-container"></div>
    </div>

    <div id="details-sheet" onclick="if(event.target === this) closeSheet()">
        <div class="sheet-content" id="sheet-content">
            </div>
    </div>

    <div id="profile-gate">
        <div class="gate-title">¿Quién está viendo?</div>
        <div class="gate-grid" id="profile-grid">
            </div>
    </div>

    <div id="app" class="hidden">
        
        <div id="tab-home" class="screen active">
            <header class="header">
                <div class="logo">Flechazo TV</div>
                <div style="width:35px; height:35px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <i class="fa-solid fa-chromecast"></i>
                </div>
            </header>

            <div id="hero-container"></div>

            <div id="sec-continue" class="section hidden">
                <div class="sec-head"><span class="sec-title">Continuar Viendo</span></div>
                <div class="h-list" id="list-continue"></div>
            </div>

            <div class="section">
                <div class="sec-head"><span class="sec-title">Top 10 en Perú</span></div>
                <div class="h-list" id="list-top10"></div>
            </div>

            <div class="section">
                <div class="sec-head"><span class="sec-title">Tendencias</span></div>
                <div class="h-list" id="list-trends"></div>
            </div>
        </div>

        <div id="tab-explore" class="screen">
            <div style="padding:15px 20px; position:sticky; top:0; z-index:90; background:var(--bg);">
                <div style="background:rgba(255,255,255,0.1); border-radius:10px; padding:12px; display:flex; gap:10px;">
                    <i class="fa-solid fa-magnifying-glass" style="color:#888;"></i>
                    <input type="text" placeholder="Buscar..." style="background:none; border:none; color:#fff; width:100%; font-size:16px;" onkeyup="runSearch(this.value)">
                </div>
            </div>
            <div id="search-results" style="padding:0 20px; display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;"></div>
        </div>

        <div id="tab-shorts" class="screen" style="padding:0;">
            <div class="shorts-container" id="shorts-feed"></div>
        </div>

        <div id="tab-profile" class="screen">
            <div style="text-align:center; padding:40px 20px;">
                <img src="" id="profile-pic-settings" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--primary);">
                <h2 id="profile-name-settings" style="margin:10px 0;"></h2>
                <div style="margin-top:30px;">
                    <div onclick="changeProfile()" style="background:var(--card); padding:15px; border-radius:10px; margin-bottom:10px; display:flex; align-items:center; gap:15px;">
                        <i class="fa-solid fa-users"></i> Cambiar Perfil
                    </div>
                    <div onclick="resetApp()" style="background:var(--card); padding:15px; border-radius:10px; display:flex; align-items:center; gap:15px;">
                        <i class="fa-solid fa-trash"></i> Borrar Datos
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="navbar" class="nav hidden">
        <div class="nav-item active" onclick="goTab('home', this)"><i class="fa-solid fa-house"></i>Inicio</div>
        <div class="nav-item" onclick="goTab('explore', this)"><i class="fa-solid fa-compass"></i>Explorar</div>
        <div class="nav-item" onclick="goTab('shorts', this)"><i class="fa-brands fa-tiktok"></i>Shorts</div>
        <div class="nav-item" onclick="goTab('profile', this)"><i class="fa-solid fa-user"></i>Perfil</div>
    </div>

    <script>
        // --- 1. CONFIG & DATA ---
        const API_URL = 'https://flechazotv.vercel.app/api/movies';
        let moviesDB = [];
        let currentProfile = null;
        let defaultProfiles = [
            { id: 1, name: 'Gamer Pro', img: 'https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg' },
            { id: 2, name: 'Kids', img: 'https://i.pinimg.com/564x/4d/9d/3e/4d9d3e8e1784534a621796d1955746f1.jpg' },
            { id: 3, name: 'Invitado', img: 'https://i.pinimg.com/564x/b6/77/cd/b677cd1cde292f2611665467fe0e7b9e.jpg' }
        ];

        // --- 2. STARTUP & PROFILES ---
        window.onload = async () => {
            try {
                const res = await fetch(API_URL);
                moviesDB = await res.json();
            } catch(e) { console.log('Offline mode'); }
            
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').style.display='none', 500);
                renderProfiles();
            }, 1500);
        };

        function renderProfiles() {
            const grid = document.getElementById('profile-grid');
            grid.innerHTML = defaultProfiles.map(p => `
                <div class="gate-item" onclick="selectProfile(${p.id})">
                    <img src="${p.img}" class="gate-img">
                    <span class="gate-name">${p.name}</span>
                </div>
            `).join('') + `
                <div class="gate-item" onclick="alert('Función Premium')">
                    <div class="gate-add">+</div>
                    <span class="gate-name">Añadir</span>
                </div>
            `;
        }

        function selectProfile(id) {
            currentProfile = defaultProfiles.find(p => p.id === id);
            document.getElementById('profile-gate').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('navbar').classList.remove('hidden');
            
            // Set User Data in Profile Tab
            document.getElementById('profile-pic-settings').src = currentProfile.img;
            document.getElementById('profile-name-settings').innerText = currentProfile.name;
            
            initAppContent();
        }

        function changeProfile() {
            document.getElementById('profile-gate').style.display = 'flex';
            document.getElementById('app').classList.add('hidden');
            document.getElementById('navbar').classList.add('hidden');
        }

        // --- 3. APP CONTENT LOADING ---
        function initAppContent() {
            if(moviesDB.length > 0) {
                renderHero(moviesDB[0]);
                renderList('list-trends', moviesDB);
                renderTop10(moviesDB);
                renderSearch(moviesDB);
                renderShorts(moviesDB);
                renderContinueWatching();
            }
        }

        // --- 4. RENDERING ---
        function renderHero(m) {
            document.getElementById('hero-container').innerHTML = `
                <div class="hero-wrap">
                    <img src="${m.img}" class="hero-bg">
                    <div class="hero-gradient"></div>
                    <div class="hero-content">
                        <div class="hero-tags"><span class="tag">Nº 1 EN SERIES</span><span class="tag">HD</span></div>
                        <h1 class="hero-title">${m.title}</h1>
                        <div class="btn-group">
                            <button class="btn btn-play" onclick="playVideo('${m.videoUrl}', ${m.id})"><i class="fa-solid fa-play"></i> Reproducir</button>
                            <button class="btn btn-info" onclick="openSheet(${m.id})"><i class="fa-solid fa-info-circle"></i> Info</button>
                        </div>
                    </div>
                </div>`;
        }

        function renderList(target, list) {
            document.getElementById(target).innerHTML = list.map(m => `
                <div class="card" onclick="openSheet(${m.id})">
                    <img src="${m.img}" class="card-img" loading="lazy">
                </div>`).join('');
        }

        function renderTop10(list) {
            document.getElementById('list-top10').innerHTML = list.slice(0, 10).map((m, i) => `
                <div class="rank-card" onclick="openSheet(${m.id})">
                    <span class="rank-num">${i+1}</span>
                    <img src="${m.img}" class="rank-img">
                </div>`).join('');
        }

        // --- 5. BOTTOM SHEET (DETALLES) ---
        function openSheet(id) {
            const m = moviesDB.find(x => x.id === id);
            const sheet = document.getElementById('details-sheet');
            const content = document.getElementById('sheet-content');
            
            // Simular datos extra (Reparto, Episodios)
            const cast = [
                {name: 'Actor 1', img: 'https://i.pravatar.cc/100?img=1'},
                {name: 'Actor 2', img: 'https://i.pravatar.cc/100?img=2'},
                {name: 'Actor 3', img: 'https://i.pravatar.cc/100?img=3'},
            ];
            const isSeries = m.cat === 'Drama' || m.cat === 'Anime';

            content.innerHTML = `
                <div class="sheet-hero">
                    <img src="${m.img}" class="sheet-img">
                    <div class="sheet-close" onclick="closeSheet()"><i class="fa-solid fa-xmark"></i></div>
                </div>
                <div class="sheet-body">
                    <h2 class="sheet-title">${m.title}</h2>
                    <div class="sheet-meta">
                        <span style="color:#46d369; font-weight:900;">98% Match</span>
                        <span>2025</span>
                        <span class="meta-tag">HD</span>
                        <span class="meta-tag">5.1</span>
                    </div>
                    
                    <div class="sheet-actions">
                        <button class="s-btn s-btn-play" onclick="playVideo('${m.videoUrl}', ${m.id}); closeSheet()"><i class="fa-solid fa-play"></i> Reproducir</button>
                        <button class="s-btn s-btn-dl" onclick="showToast('Descargando...', 'download')"><i class="fa-solid fa-download"></i> Descargar</button>
                    </div>

                    <p class="sheet-desc">${m.desc}</p>
                    
                    <h4 style="margin-bottom:10px;">Reparto</h4>
                    <div class="cast-row">
                        ${cast.map(c => `<div class="cast-item"><img src="${c.img}" class="cast-img"><div class="cast-name">${c.name}</div></div>`).join('')}
                    </div>

                    ${isSeries ? `
                        <h4 style="margin:20px 0 10px;">Episodios</h4>
                        <div>
                            <div class="ep-item" onclick="playVideo('${m.videoUrl}', ${m.id})">
                                <img src="${m.img}" class="ep-img">
                                <div class="ep-info"><h4>1. El Comienzo</h4><p>45 min</p></div>
                            </div>
                            <div class="ep-item" onclick="playVideo('${m.videoUrl}', ${m.id})">
                                <img src="${m.img}" class="ep-img">
                                <div class="ep-info"><h4>2. La Revelación</h4><p>48 min</p></div>
                            </div>
                        </div>
                    ` : ''}
                    <br><br>
                </div>
            `;
            
            sheet.style.display = 'flex';
            // Pequeño delay para la animación CSS
            setTimeout(() => sheet.classList.add('open'), 10);
        }

        function closeSheet() {
            const sheet = document.getElementById('details-sheet');
            sheet.classList.remove('open');
            setTimeout(() => sheet.style.display = 'none', 300);
        }

        // --- 6. PLAYER ---
        function playVideo(url, id) {
            const overlay = document.getElementById('player-fs');
            const container = document.getElementById('video-container');
            const hist = JSON.parse(localStorage.getItem('f_hist')) || {};
            container.innerHTML = '';
            
            if(url.includes('youtu') || !url.match(/\.(mp4|webm)$/i)) {
                let vId = url.includes('v=') ? url.split('v=')[1] : url.split('/').pop();
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/${vId}?autoplay=1&rel=0&modestbranding=1" allowfullscreen></iframe>`;
                saveHistory(id, 100, 100);
            } else {
                const v = document.createElement('video');
                v.src = url; v.controls = true; v.autoplay = true; 
                if(hist[id]) v.currentTime = hist[id].time;
                v.addEventListener('timeupdate', () => { if(v.currentTime>5) saveHistory(id, v.currentTime, v.duration); });
                container.appendChild(v);
            }
            overlay.style.display = 'flex';
        }
        function closePlayer() {
            document.getElementById('video-container').innerHTML = '';
            document.getElementById('player-fs').style.display = 'none';
            renderContinueWatching();
        }
        function saveHistory(id, time, dur) {
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            h[id] = { time, dur, ts: Date.now() };
            localStorage.setItem('f_hist', JSON.stringify(h));
        }

        // --- 7. CONTINUE WATCHING ---
        function renderContinueWatching() {
            const hist = JSON.parse(localStorage.getItem('f_hist')) || {};
            const ids = Object.keys(hist).sort((a,b) => hist[b].ts - hist[a].ts);
            const sec = document.getElementById('sec-continue');
            
            if(ids.length === 0) { sec.classList.add('hidden'); return; }
            sec.classList.remove('hidden');
            
            document.getElementById('list-continue').innerHTML = ids.map(id => {
                const m = moviesDB.find(x => x.id == id);
                if(!m) return '';
                const h = hist[id];
                const pct = h.dur ? (h.time/h.dur)*100 : 100;
                return `
                <div class="wide-card" onclick="playVideo('${m.videoUrl}', ${m.id})">
                    <div class="delete-btn" onclick="event.stopPropagation(); deleteHist(${id})"><i class="fa-solid fa-xmark" style="font-size:12px;"></i></div>
                    <div class="wide-img-box">
                        <img src="${m.img}" class="wide-img">
                        <div class="play-overlay"><div class="play-circle"><i class="fa-solid fa-play" style="color:#fff"></i></div></div>
                        <div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div>
                    </div>
                    <div class="wide-info"><span>${m.title}</span><span>Continuar</span></div>
                </div>`;
            }).join('');
        }
        function deleteHist(id) {
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            delete h[id];
            localStorage.setItem('f_hist', JSON.stringify(h));
            renderContinueWatching();
        }

        // --- 8. SHORTS ---
        function renderShorts(list) {
            const feed = [...list, ...list];
            document.getElementById('shorts-feed').innerHTML = feed.map(m => `
                <div class="short-item">
                    <video src="${m.videoUrl}" class="short-video" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="short-ui">
                        <div class="short-right">
                            <div class="s-action" onclick="showToast('Te gusta', 'heart')"><div class="s-icon"><i class="fa-solid fa-heart"></i></div><span>Like</span></div>
                            <div class="s-action"><div class="s-icon"><i class="fa-solid fa-comment-dots"></i></div><span>Comment</span></div>
                            <div class="s-action"><div class="s-icon"><i class="fa-solid fa-share"></i></div><span>Share</span></div>
                        </div>
                        <div style="position:absolute; bottom:20px; left:15px; text-align:left; text-shadow:0 1px 3px #000;">
                            <h3 style="margin:0">${m.title}</h3>
                            <p style="margin:5px 0 0; font-size:13px;">${m.cat}</p>
                        </div>
                    </div>
                </div>`).join('');
        }

        // --- 9. UTILS ---
        function goTab(t, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }
        function runSearch(val) {
            const res = document.getElementById('search-results');
            if(!val) return renderSearch(moviesDB);
            const filtered = moviesDB.filter(m => m.title.toLowerCase().includes(val.toLowerCase()));
            renderSearch(filtered);
        }
        function renderSearch(list) {
            document.getElementById('search-results').innerHTML = list.map(m => `
                <div onclick="openSheet(${m.id})"><img src="${m.img}" style="width:100%; height:150px; border-radius:6px; object-fit:cover; background:#222;"></div>
            `).join('');
        }
        function showToast(msg, icon) {
            const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<i class="fa-solid fa-${icon}"></i> <span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        function resetApp() { if(confirm('¿Borrar todo?')) { localStorage.clear(); location.reload(); } }
        
        // CSS Animation for spin
        const style = document.createElement('style');
        style.innerHTML = `@keyframes spin { to { transform: rotate(360deg); } } @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }`;
        document.head.appendChild(style);

    </script>
</body>
</html>
