<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f0f1a">
    <title>Flechazo TV - Ultimate PRO</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE CSS & TEMAS --- */
        :root { 
            --bg: #0f0f1a; --card: #1e1e2d; --primary: #E50914; --text: #fff;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        
        /* Temas Personalizados */
        body.theme-blue { --bg: #0a101a; --card: #15202b; --primary: #0088cc; }
        body.theme-green { --bg: #0a1a10; --card: #152b1d; --primary: #00cc66; }
        body.theme-purple { --bg: #150a1a; --card: #25152b; --primary: #aa00cc; }
        body.theme-gold { --bg: #1a150a; --card: #2b2515; --primary: #cca300; }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: calc(85px + var(--safe-bottom)); overflow-x: hidden; user-select: none; transition: background 0.3s; }

        /* --- 2. PANTALLA DE CARGA (SPLASH) --- */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        .splash-logo { font-size: 32px; font-weight: 900; color: var(--primary); letter-spacing: -1px; text-transform: uppercase; animation: pulse 2s infinite; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-top: 20px; }

        /* --- 3. HEADER & NOTIFICACIONES --- */
        .header { position: sticky; top: 0; padding: calc(10px + var(--safe-top)) 20px 10px; background: rgba(15,15,26,0.95); backdrop-filter: blur(10px); z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { color: var(--primary); font-weight: 900; font-size: 22px; text-transform: uppercase; }

        .notif-btn { position: relative; cursor: pointer; }
        .notif-badge { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: none; }
        .notif-panel { position: absolute; top: 60px; right: 10px; width: 280px; background: var(--card); border: 1px solid #333; border-radius: 12px; padding: 10px; z-index: 200; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .notif-item { display: flex; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .notif-item:last-child { border: none; }
        .notif-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; background: #333; }
        .notif-text h4 { font-size: 13px; margin: 0; }
        .notif-text p { font-size: 11px; color: #aaa; margin: 3px 0 0; }

        /* --- 4. HERO BANNER --- */
        .hero-wrap { height: 65vh; position: relative; display: flex; align-items: flex-end; margin-top: -60px; }
        .hero-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .hero-gradient { position: absolute; inset: 0; background: linear-gradient(to top, var(--bg) 0%, rgba(15,15,26,0.2) 50%, rgba(15,15,26,0.95) 100%); }
        .hero-content { padding: 20px; z-index: 2; width: 100%; }
        .hero-badge { background: #fff; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; display: inline-block; margin-bottom: 8px; }
        .hero-title { font-size: 38px; font-weight: 900; line-height: 1; margin-bottom: 8px; text-shadow: 0 2px 10px #000; }
        .hero-desc { font-size: 13px; color: #ccc; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; height: 42px; border-radius: 6px; border: none; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; }
        .btn-play { background: var(--text); color: #000; }
        .btn-list { background: rgba(255,255,255,0.2); color: #fff; backdrop-filter: blur(5px); }

        /* --- 5. UI ELEMENTS --- */
        .screen { display: none; animation: fadeEffect 0.3s; padding-bottom: 20px; }
        .screen.active { display: block; }

        .section { margin-top: 30px; }
        .sec-head { padding: 0 20px 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .sec-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .h-list { display: flex; overflow-x: auto; gap: 12px; padding: 0 20px; scrollbar-width: none; }
        
        .card { width: 110px; flex-shrink: 0; position: relative; cursor: pointer; }
        .card-img { width: 100%; height: 160px; border-radius: 6px; object-fit: cover; background: #222; }

        /* Tarjeta Continuar Viendo (Ancha con Barra Roja) */
        .wide-card { width: 200px; flex-shrink: 0; position: relative; cursor: pointer; }
        .wide-img-box { position: relative; height: 110px; border-radius: 6px; overflow: hidden; }
        .wide-img { width: 100%; height: 100%; object-fit: cover; }
        .play-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
        .progress-bg { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .wide-info { margin-top: 5px; display: flex; justify-content: space-between; font-size: 10px; color: #aaa; }
        
        .delete-btn { position: absolute; top: 5px; right: 5px; width: 22px; height: 22px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; z-index: 10; backdrop-filter: blur(2px); border: 1px solid rgba(255,255,255,0.2); }

        /* --- 6. BUSCADOR & SHORTS --- */
        .search-wrap { padding: 10px 20px; position: sticky; top: 0; z-index: 90; background: var(--bg); }
        .search-box { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        .search-input { background: transparent; border: none; color: #fff; width: 100%; font-size: 14px; }
        .grid-results { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 20px; }
        .grid-img { width: 100%; height: 150px; border-radius: 6px; object-fit: cover; background: #222; }

        .shorts-container { height: calc(100vh - 80px); overflow-y: scroll; scroll-snap-type: y mandatory; background: #000; }
        .short-item { height: 100%; width: 100%; scroll-snap-align: start; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        .short-video { width: 100%; height: 100%; object-fit: cover; }
        .short-info { position: absolute; bottom: 20px; left: 15px; right: 60px; z-index: 10; text-shadow: 0 1px 2px #000; }

        /* --- 7. PERFIL & TEMAS --- */
        .profile-head { text-align: center; padding: 40px 20px; }
        .avatar { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; }
        .stats { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 8px; width: 100px; }

        .theme-selector { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .theme-dot { width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; }

        /* --- 8. PLAYER & MODALS --- */
        .player-fs { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; align-items: center; justify-content: center; }
        .close-player { position: absolute; top: calc(20px + var(--safe-top)); left: 20px; font-size: 24px; color: #fff; z-index: 5001; cursor: pointer; filter: drop-shadow(0 0 5px #000); }
        #video-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; max-height: 100%; }
        iframe { width: 100%; height: 100%; border: none; }

        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--card); padding: 25px; border-radius: 12px; width: 80%; max-width: 300px; text-align: center; border: 1px solid #333; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .m-btn { flex: 1; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        
        /* NAVBAR */
        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(15,15,26,0.98); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0 calc(10px + var(--safe-bottom)); z-index: 2000; backdrop-filter: blur(10px); }
        .nav-item { color: #666; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item i { font-size: 20px; }

        .hidden { display: none !important; }
        .loader-center { display: flex; justify-content: center; padding: 20px; color: #666; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 50% { opacity: 0.5; } }
        @keyframes fadeEffect { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">Flechazo TV</div>
        <div class="spinner"></div>
    </div>

    <div id="confirm-modal" class="modal-bg">
        <div class="modal-box">
            <h3>¿Eliminar título?</h3>
            <p style="color:#aaa; font-size:13px; margin-top:5px;">Se eliminará de tu historial.</p>
            <div class="modal-btns">
                <button class="m-btn" style="background:#333; color:#fff;" onclick="closeModal()">Cancelar</button>
                <button class="m-btn" style="background:var(--primary); color:#fff;" onclick="confirmDelete()">Eliminar</button>
            </div>
        </div>
    </div>

    <div id="player-fs" class="player-fs">
        <i class="fa-solid fa-chevron-left close-player" onclick="closePlayer()"></i>
        <div id="video-container"></div>
    </div>

    <div id="app">

        <div id="tab-home" class="screen active">
            <header class="header">
                <div class="logo">Flechazo TV</div>
                <div class="notif-btn" onclick="toggleNotifs()">
                    <i class="fa-regular fa-bell" style="font-size: 22px;"></i>
                    <span class="notif-badge" id="n-badge"></span>
                    <div class="notif-panel" id="n-panel">
                        <div style="color:#888; text-align:center; padding:10px;">Cargando notificaciones...</div>
                    </div>
                </div>
            </header>

            <div id="hero-container">
                <div style="height:65vh; background:#111; display:flex; align-items:center; justify-content:center;">
                    <i class="fa-solid fa-spinner fa-spin" style="color:#333; font-size:24px;"></i>
                </div>
            </div>

            <div id="sec-continue" class="section hidden">
                <div class="sec-head"><span class="sec-title"><i class="fa-solid fa-clock-rotate-left" style="color:var(--primary)"></i> Continuar Viendo</span></div>
                <div class="h-list" id="list-continue"></div>
            </div>

            <div id="sec-mylist" class="section hidden">
                <div class="sec-head"><span class="sec-title"><i class="fa-solid fa-check" style="color:#46d369"></i> Mi Lista</span></div>
                <div class="h-list" id="list-mylist"></div>
            </div>

            <div class="section">
                <div class="sec-head"><span class="sec-title">Tendencias Globales</span></div>
                <div class="h-list" id="list-trends">
                    <div class="loader-center"><i class="fa-solid fa-spinner fa-spin"></i></div>
                </div>
            </div>
        </div>

        <div id="tab-explore" class="screen">
            <div class="search-wrap">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass" style="color:#777;"></i>
                    <input type="text" class="search-input" id="search-inp" placeholder="Buscar películas, anime, Free Fire..." onkeyup="runSearch()">
                </div>
            </div>
            <div style="padding:0 20px;">
                <h3 id="search-title" style="margin:10px 0; font-size:16px;">Más buscados</h3>
                <div class="grid-results" id="search-grid"></div>
            </div>
        </div>

        <div id="tab-shorts" class="screen" style="padding:0;">
            <div class="shorts-container" id="shorts-feed"></div>
        </div>

        <div id="tab-profile" class="screen">
            <div class="profile-head">
                <img src="https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg" class="avatar">
                <h2 style="margin:10px 0 5px;">Gamer Pro</h2>
                <p style="color:#777; font-size:13px;">Plan VIP 2025</p>

                <div class="stats">
                    <div class="stat-card">
                        <h3 id="st-watched" style="color:var(--primary)">0</h3>
                        <span style="font-size:11px; color:#aaa;">Vistos</span>
                    </div>
                    <div class="stat-card">
                        <h3 id="st-list" style="color:#fff">0</h3>
                        <span style="font-size:11px; color:#aaa;">Lista</span>
                    </div>
                </div>
                
                <h4 style="margin-top:20px; color:#aaa; font-size:12px; text-transform:uppercase;">Temas de App</h4>
                <div class="theme-selector">
                    <div class="theme-dot" style="background:#E50914;" onclick="setTheme('default')"></div>
                    <div class="theme-dot" style="background:#0088cc;" onclick="setTheme('blue')"></div>
                    <div class="theme-dot" style="background:#00cc66;" onclick="setTheme('green')"></div>
                    <div class="theme-dot" style="background:#aa00cc;" onclick="setTheme('purple')"></div>
                    <div class="theme-dot" style="background:#cca300;" onclick="setTheme('gold')"></div>
                </div>

                <div style="text-align:left; margin-top:30px;">
                    <div onclick="resetApp()" style="background:var(--card); padding:15px; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; cursor:pointer;">
                        <i class="fa-solid fa-trash" style="margin-right:15px; color:#666;"></i> Borrar Historial
                    </div>
                </div>
            </div>
        </div>

    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="goTab('home', this)"><i class="fa-solid fa-house"></i>Inicio</div>
        <div class="nav-item" onclick="goTab('explore', this)"><i class="fa-solid fa-compass"></i>Explorar</div>
        <div class="nav-item" onclick="goTab('shorts', this)"><i class="fa-brands fa-tiktok"></i>Shorts</div>
        <div class="nav-item" onclick="goTab('profile', this)"><i class="fa-solid fa-user"></i>Perfil</div>
    </nav>

    <script>
        const API_URL = 'https://flechazotv.vercel.app/api';
        let moviesDB = [];
        let deleteId = null;

        // --- 1. INICIALIZACIÓN ---
        window.onload = async () => {
            try {
                // Restaurar tema
                const savedTheme = localStorage.getItem('f_theme');
                if(savedTheme) document.body.className = 'theme-' + savedTheme;

                // Cargar datos
                const [movRes, notifRes] = await Promise.all([
                    fetch(`${API_URL}/movies`),
                    fetch(`${API_URL}/notifications`)
                ]);
                const data = await movRes.json();
                const notifs = await notifRes.json();

                if(data.length > 0) {
                    moviesDB = data;
                    renderHero(data[0]);
                    renderList('list-trends', data);
                    renderGrid(data);
                    renderShorts(data);
                    renderNotifs(notifs);
                    loadUserData();
                }

            } catch(e) { console.log('Offline Mode'); } 
            finally {
                // Ocultar Splash
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    splash.style.opacity = '0';
                    setTimeout(() => splash.style.visibility = 'hidden', 500);
                }, 1500);
            }
        };

        // --- 2. NAVEGACIÓN & TEMAS ---
        function goTab(tab, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(tab === 'profile') loadUserData();
        }

        function setTheme(color) {
            document.body.className = 'theme-' + color;
            localStorage.setItem('f_theme', color);
        }

        // --- 3. NOTIFICACIONES ---
        function renderNotifs(list) {
            const panel = document.getElementById('n-panel');
            if(!list || list.length === 0) {
                panel.innerHTML = '<div style="padding:10px;text-align:center;font-size:12px;color:#666">Sin notificaciones</div>';
                return;
            }
            document.getElementById('n-badge').style.display = 'block';
            panel.innerHTML = list.map(n => `
                <div class="notif-item">
                    <div class="notif-img"></div>
                    <div class="notif-text">
                        <h4>${n.title}</h4>
                        <p>${n.msg}</p>
                    </div>
                </div>
            `).join('');
        }
        function toggleNotifs() {
            const p = document.getElementById('n-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
            document.getElementById('n-badge').style.display = 'none';
        }

        // --- 4. RENDER HOME ---
        function renderHero(m) {
            const inList = checkList(m.id);
            document.getElementById('hero-container').innerHTML = `
                <div class="hero-wrap">
                    <img src="${m.img}" class="hero-bg">
                    <div class="hero-gradient"></div>
                    <div class="hero-content">
                        <div class="hero-badge">DESTACADO</div>
                        <h1 class="hero-title">${m.title}</h1>
                        <p class="hero-desc">${m.desc}</p>
                        <div class="btn-group">
                            <button class="btn btn-play" onclick="playVideo('${m.videoUrl}', ${m.id})"><i class="fa-solid fa-play"></i> Ver</button>
                            <button class="btn btn-list" onclick="toggleList(${m.id}, this)">
                                <i class="fa-solid ${inList ? 'fa-check' : 'fa-plus'}"></i> ${inList ? 'Lista' : 'Mi Lista'}
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        function renderList(target, list) {
            document.getElementById(target).innerHTML = list.map(m => `
                <div class="card" onclick="playVideo('${m.videoUrl}', ${m.id})">
                    <img src="${m.img}" class="card-img" loading="lazy">
                </div>`).join('');
        }

        // --- 5. BUSCADOR & SHORTS ---
        function runSearch() {
            const val = document.getElementById('search-inp').value.toLowerCase();
            const filtered = val ? moviesDB.filter(m => m.title.toLowerCase().includes(val) || m.cat.toLowerCase().includes(val)) : moviesDB;
            renderGrid(filtered);
            document.getElementById('search-title').innerText = val ? "Resultados" : "Más buscados";
        }

        function renderGrid(list) {
            const grid = document.getElementById('search-grid');
            if(list.length === 0) { grid.innerHTML = '<p style="color:#666; grid-column:span 3; text-align:center;">Sin resultados.</p>'; return; }
            grid.innerHTML = list.map(m => `
                <div onclick="playVideo('${m.videoUrl}', ${m.id})">
                    <img src="${m.img}" class="grid-img" loading="lazy">
                </div>`).join('');
        }

        function renderShorts(list) {
            const feed = [...list, ...list]; // Duplicar para demo
            document.getElementById('shorts-feed').innerHTML = feed.map(m => `
                <div class="short-item">
                    <video src="${m.videoUrl}" class="short-video" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="short-info">
                        <h3>${m.title}</h3>
                        <p>#${m.cat} #FlechazoTV</p>
                    </div>
                </div>`).join('');
        }

        // --- 6. USER DATA & LISTS ---
        function loadUserData() {
            const history = JSON.parse(localStorage.getItem('f_hist')) || {};
            const list = JSON.parse(localStorage.getItem('f_list')) || [];
            
            document.getElementById('st-watched').innerText = Object.keys(history).length;
            document.getElementById('st-list').innerText = list.length;

            // Render Continuar Viendo
            const histIds = Object.keys(history).sort((a,b) => history[b].ts - history[a].ts);
            const contSec = document.getElementById('sec-continue');
            const contList = document.getElementById('list-continue');
            
            if(histIds.length === 0) contSec.classList.add('hidden');
            else {
                contSec.classList.remove('hidden');
                contList.innerHTML = histIds.map(id => {
                    const m = moviesDB.find(x => x.id == id);
                    if(!m) return '';
                    const h = history[id];
                    const pct = h.dur ? (h.time / h.dur) * 100 : 100;
                    return `
                    <div class="wide-card" onclick="playVideo('${m.videoUrl}', ${m.id})">
                        <div class="delete-btn" onclick="askDelete(event, ${id})"><i class="fa-solid fa-xmark" style="font-size:12px;"></i></div>
                        <div class="wide-img-box">
                            <img src="${m.img}" class="wide-img">
                            <div class="play-overlay"><i class="fa-solid fa-play" style="color:#fff"></i></div>
                            <div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div>
                        </div>
                        <div class="wide-info"><span>${m.title}</span><span>${Math.round(pct)}% visto</span></div>
                    </div>`;
                }).join('');
            }

            // Render Mi Lista
            const listSec = document.getElementById('sec-mylist');
            const listWrap = document.getElementById('list-mylist');
            if(list.length === 0) listSec.classList.add('hidden');
            else {
                listSec.classList.remove('hidden');
                const myMovies = moviesDB.filter(m => list.includes(m.id));
                listWrap.innerHTML = myMovies.map(m => `
                    <div class="card" onclick="playVideo('${m.videoUrl}', ${m.id})">
                        <img src="${m.img}" class="card-img">
                    </div>`).join('');
            }
        }

        function toggleList(id, btn) {
            let list = JSON.parse(localStorage.getItem('f_list')) || [];
            if(list.includes(id)) {
                list = list.filter(x => x !== id);
                if(btn) btn.innerHTML = '<i class="fa-solid fa-plus"></i> Mi Lista';
            } else {
                list.push(id);
                if(btn) btn.innerHTML = '<i class="fa-solid fa-check"></i> Lista';
            }
            localStorage.setItem('f_list', JSON.stringify(list));
            loadUserData();
        }
        function checkList(id) { return (JSON.parse(localStorage.getItem('f_list')) || []).includes(id); }

        // --- 7. BORRAR HISTORIAL ---
        function askDelete(e, id) {
            e.stopPropagation();
            deleteId = id;
            document.getElementById('confirm-modal').style.display = 'flex';
        }
        function confirmDelete() {
            const history = JSON.parse(localStorage.getItem('f_hist')) || {};
            delete history[deleteId];
            localStorage.setItem('f_hist', JSON.stringify(history));
            closeModal();
            loadUserData();
        }
        function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
        function resetApp() { if(confirm("¿Borrar historial y favoritos?")) { localStorage.clear(); location.reload(); } }

        // --- 8. REPRODUCTOR UNIVERSAL ---
        let currVid = null;
        function playVideo(url, id) {
            const wrap = document.getElementById('video-container');
            const overlay = document.getElementById('player-fs');
            const hist = JSON.parse(localStorage.getItem('f_hist')) || {};
            wrap.innerHTML = '';

            if(url.includes('youtu') || url.includes('vimeo') || !url.match(/\.(mp4|webm|ogg)$/i)) {
                // Iframe
                let src = url;
                if(url.includes('youtu')) {
                    const vid = url.includes('v=') ? url.split('v=')[1] : url.split('/').pop();
                    src = `https://www.youtube.com/embed/${vid}?autoplay=1&rel=0&modestbranding=1`;
                }
                wrap.innerHTML = `<iframe src="${src}" width="100%" height="100%" allowfullscreen allow="autoplay"></iframe>`;
                saveProg(id, 100, 100);
            } else {
                // MP4
                const v = document.createElement('video');
                v.src = url; v.controls = true; v.autoplay = true; v.playsInline = true;
                if(hist[id]) v.currentTime = hist[id].time;
                v.addEventListener('timeupdate', () => { if(v.currentTime > 2) saveProg(id, v.currentTime, v.duration); });
                wrap.appendChild(v);
                currVid = v;
            }
            overlay.style.display = 'flex';
        }

        function saveProg(id, time, dur) {
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            h[id] = { time, dur, ts: Date.now() };
            localStorage.setItem('f_hist', JSON.stringify(h));
        }

        function closePlayer() {
            if(currVid) currVid.pause();
            document.getElementById('video-container').innerHTML = '';
            document.getElementById('player-fs').style.display = 'none';
            loadUserData();
        }
    </script>
</body>
</html>
