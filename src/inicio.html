<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f0f1a">
    <title>Flechazo TV - GOD TIER</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE CSS --- */
        :root { 
            --bg: #0f0f1a; --card: #1e1e2d; --primary: #E50914; --text: #fff;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        
        /* Temas */
        body.theme-blue { --bg: #0a101a; --card: #15202b; --primary: #0088cc; }
        body.theme-green { --bg: #0a1a10; --card: #152b1d; --primary: #00cc66; }
        body.theme-purple { --bg: #150a1a; --card: #25152b; --primary: #aa00cc; }
        body.theme-gold { --bg: #1a150a; --card: #2b2515; --primary: #cca300; }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: calc(85px + var(--safe-bottom)); overflow-x: hidden; user-select: none; transition: background 0.3s; }

        /* --- 2. SPLASH SCREEN --- */
        #splash-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s; }
        .splash-logo { font-size: 32px; font-weight: 900; color: var(--primary); letter-spacing: -1px; text-transform: uppercase; animation: pulse 2s infinite; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-top: 20px; }

        /* --- 3. TOAST NOTIFICATION (DESCARGAS) --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 7000; width: 90%; max-width: 350px; }
        .toast { background: rgba(30,30,40,0.95); backdrop-filter: blur(10px); border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; animation: slideDown 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .toast-icon { color: var(--primary); font-size: 20px; }
        .toast-body { flex: 1; }
        .toast-title { font-size: 13px; font-weight: bold; margin-bottom: 3px; }
        .toast-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
        .toast-bar-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 2px; transition: width 0.2s; }

        /* --- 4. HEADER & HERO --- */
        .header { position: sticky; top: 0; padding: calc(10px + var(--safe-top)) 20px 10px; background: rgba(15,15,26,0.95); backdrop-filter: blur(10px); z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo { color: var(--primary); font-weight: 900; font-size: 22px; text-transform: uppercase; }
        
        .hero-wrap { height: 70vh; position: relative; display: flex; align-items: flex-end; margin-top: -60px; }
        .hero-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .hero-gradient { position: absolute; inset: 0; background: linear-gradient(to top, var(--bg) 0%, rgba(15,15,26,0.2) 50%, rgba(15,15,26,0.95) 100%); }
        .hero-content { padding: 20px; z-index: 2; width: 100%; }
        .hero-tags { display: flex; gap: 8px; margin-bottom: 8px; }
        .tag { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .hero-title { font-size: 40px; font-weight: 900; line-height: 1; margin-bottom: 10px; text-shadow: 0 2px 10px #000; }
        .hero-actions { display: flex; gap: 15px; margin-bottom: 15px; }
        .action-icon { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #ddd; gap: 4px; cursor: pointer; }
        .action-icon i { font-size: 20px; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; height: 45px; border-radius: 8px; border: none; font-weight: bold; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn-play { background: var(--text); color: #000; }
        .btn-glass { background: rgba(255,255,255,0.2); color: #fff; backdrop-filter: blur(5px); }

        /* --- 5. LISTAS Y RANKING --- */
        .section { margin-top: 35px; }
        .sec-head { padding: 0 20px 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .sec-title { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .h-list { display: flex; overflow-x: auto; gap: 14px; padding: 0 20px; scrollbar-width: none; }
        
        .card { width: 115px; flex-shrink: 0; position: relative; cursor: pointer; }
        .card-img { width: 100%; height: 165px; border-radius: 6px; object-fit: cover; background: #222; }
        
        /* Ranking Top 10 */
        .rank-card { width: 140px; flex-shrink: 0; position: relative; display: flex; align-items: flex-end; cursor: pointer; margin-left: 15px; }
        .rank-number { position: absolute; left: -20px; bottom: -5px; font-size: 90px; font-weight: 900; color: #000; -webkit-text-stroke: 2px #555; font-family: impact, sans-serif; line-height: 0.8; z-index: -1; }
        .rank-img { width: 110px; height: 160px; border-radius: 6px; object-fit: cover; }

        /* --- 6. SHORTS TIKTOK STYLE --- */
        .shorts-container { height: calc(100vh - 80px); overflow-y: scroll; scroll-snap-type: y mandatory; background: #000; }
        .short-item { height: 100%; width: 100%; scroll-snap-align: start; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        .short-video { width: 100%; height: 100%; object-fit: cover; }
        .short-ui { position: absolute; inset: 0; pointer-events: none; }
        .short-right { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; pointer-events: auto; }
        .s-action { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #fff; font-size: 11px; text-shadow: 0 1px 2px #000; cursor: pointer; }
        .s-icon-bg { width: 45px; height: 45px; background: rgba(0,0,0,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; backdrop-filter: blur(2px); }
        .short-bottom { position: absolute; bottom: 20px; left: 15px; right: 80px; text-shadow: 0 1px 3px #000; text-align: left; }

        /* --- 7. PERFIL --- */
        .profile-head { text-align: center; padding: 40px 20px; }
        .avatar-container { position: relative; width: 100px; height: 100px; margin: 0 auto; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; }
        .edit-badge { position: absolute; bottom: 0; right: 0; background: var(--card); padding: 5px; border-radius: 50%; border: 1px solid #333; cursor: pointer; }
        .stats { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 8px; width: 100px; }
        
        .theme-selector { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .theme-dot { width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; }

        /* --- 8. MODALS & PLAYER --- */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); animation: fadeIn 0.2s; }
        .modal-box { background: var(--card); padding: 25px; border-radius: 16px; width: 85%; max-width: 320px; text-align: center; border: 1px solid #333; transform: scale(0.9); animation: popIn 0.2s forwards; }
        .inp-field { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 12px; color: #fff; border-radius: 8px; margin-bottom: 15px; }
        
        .player-fs { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; align-items: center; justify-content: center; }
        .close-player { position: absolute; top: calc(20px + var(--safe-top)); left: 20px; font-size: 24px; color: #fff; z-index: 5001; cursor: pointer; filter: drop-shadow(0 0 5px #000); }
        #video-container { width: 100%; height: 100%; }
        video, iframe { width: 100%; height: 100%; border: none; }

        /* --- 9. NAV & UTILS --- */
        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(15,15,26,0.98); border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0 calc(10px + var(--safe-bottom)); z-index: 2000; backdrop-filter: blur(10px); }
        .nav-item { color: #666; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item i { font-size: 20px; }

        .hidden { display: none !important; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 50% { opacity: 0.5; } }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes popIn { to { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">Flechazo TV</div>
        <div class="spinner"></div>
    </div>

    <div id="toast-container"></div>

    <div id="edit-modal" class="modal-bg">
        <div class="modal-box">
            <h3>Editar Perfil</h3>
            <p style="color:#aaa; font-size:13px; margin-bottom:15px;">Personaliza tu experiencia</p>
            <input type="text" id="edit-name" class="inp-field" placeholder="Tu Nombre">
            <input type="text" id="edit-pic" class="inp-field" placeholder="URL de Imagen">
            <div style="display:flex; gap:10px;">
                <button onclick="closeEdit()" style="flex:1; padding:10px; border-radius:8px; border:none; background:#333; color:#fff;">Cancelar</button>
                <button onclick="saveProfile()" style="flex:1; padding:10px; border-radius:8px; border:none; background:var(--primary); color:#fff;">Guardar</button>
            </div>
        </div>
    </div>

    <div id="player-fs" class="player-fs">
        <i class="fa-solid fa-chevron-left close-player" onclick="closePlayer()"></i>
        <div id="video-container"></div>
    </div>

    <div id="app">

        <div id="tab-home" class="screen active">
            <header class="header">
                <div class="logo">Flechazo TV</div>
                <div onclick="showToast('Sin notificaciones nuevas', 'bell')" style="width:35px; height:35px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <i class="fa-solid fa-bell"></i>
                </div>
            </header>

            <div id="hero-container">
                <div style="height:65vh; background:#111; display:flex; align-items:center; justify-content:center;">
                    <i class="fa-solid fa-spinner fa-spin" style="color:#333; font-size:24px;"></i>
                </div>
            </div>

            <div id="sec-continue" class="section hidden">
                <div class="sec-head"><span class="sec-title">Continuar Viendo</span></div>
                <div class="h-list" id="list-continue"></div>
            </div>

            <div class="section">
                <div class="sec-head"><span class="sec-title">Top 10 en Perú Hoy</span></div>
                <div class="h-list" id="list-top10"></div>
            </div>

            <div class="section">
                <div class="sec-head"><span class="sec-title">Tendencias</span></div>
                <div class="h-list" id="list-trends"></div>
            </div>
        </div>

        <div id="tab-explore" class="screen">
            <div style="padding:10px 20px; position:sticky; top:0; z-index:90; background:var(--bg);">
                <div style="background:rgba(255,255,255,0.1); border-radius:8px; padding:12px; display:flex; gap:10px;">
                    <i class="fa-solid fa-magnifying-glass" style="color:#888;"></i>
                    <input type="text" id="search-inp" placeholder="Buscar..." style="background:none; border:none; color:#fff; width:100%; font-size:16px;" onkeyup="runSearch()">
                </div>
            </div>
            <div style="padding:0 20px;">
                <h3 id="search-title" style="margin:10px 0;">Explorar</h3>
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;" id="search-grid"></div>
            </div>
        </div>

        <div id="tab-shorts" class="screen" style="padding:0;">
            <div class="shorts-container" id="shorts-feed"></div>
        </div>

        <div id="tab-profile" class="screen">
            <div class="profile-head">
                <div class="avatar-container" onclick="openEdit()">
                    <img src="https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg" class="avatar" id="p-avatar">
                    <div class="edit-badge"><i class="fa-solid fa-pencil" style="font-size:12px;"></i></div>
                </div>
                <h2 style="margin:10px 0 5px;" id="p-name">Gamer Pro</h2>
                <p style="color:#777; font-size:13px;">Plan VIP Ultimate</p>

                <div class="stats">
                    <div class="stat-card"><h3 id="st-likes" style="color:var(--primary)">0</h3><span style="font-size:11px;color:#aaa">Likes</span></div>
                    <div class="stat-card"><h3 id="st-list" style="color:#fff">0</h3><span style="font-size:11px;color:#aaa">Lista</span></div>
                </div>
                
                <h4 style="margin-top:20px; color:#aaa; font-size:12px;">PERSONALIZAR TEMA</h4>
                <div class="theme-selector">
                    <div class="theme-dot" style="background:#E50914;" onclick="setTheme('default')"></div>
                    <div class="theme-dot" style="background:#0088cc;" onclick="setTheme('blue')"></div>
                    <div class="theme-dot" style="background:#00cc66;" onclick="setTheme('green')"></div>
                    <div class="theme-dot" style="background:#aa00cc;" onclick="setTheme('purple')"></div>
                    <div class="theme-dot" style="background:#cca300;" onclick="setTheme('gold')"></div>
                </div>

                <div style="margin-top:30px;">
                    <div onclick="resetApp()" style="background:var(--card); padding:15px; border-radius:8px; display:flex; align-items:center; cursor:pointer;">
                        <i class="fa-solid fa-trash" style="margin-right:15px; color:#666;"></i> Restablecer Datos
                    </div>
                </div>
            </div>
        </div>

    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="goTab('home', this)"><i class="fa-solid fa-house"></i>Inicio</div>
        <div class="nav-item" onclick="goTab('explore', this)"><i class="fa-solid fa-compass"></i>Explorar</div>
        <div class="nav-item" onclick="goTab('shorts', this)"><i class="fa-brands fa-tiktok"></i>Shorts</div>
        <div class="nav-item" onclick="goTab('profile', this)"><i class="fa-solid fa-user"></i>Perfil</div>
    </nav>

    <script>
        const API_URL = 'https://flechazotv.vercel.app/api/movies';
        let moviesDB = [];
        
        // --- 1. CORE LOGIC ---
        window.onload = async () => {
            try {
                // Load Theme & User
                const theme = localStorage.getItem('f_theme');
                if(theme) document.body.className = 'theme-'+theme;
                updateProfileUI();

                // Fetch Data
                const res = await fetch(API_URL);
                const data = await res.json();
                
                if(data.length > 0) {
                    moviesDB = data;
                    renderHero(data[0]);
                    renderList('list-trends', data);
                    renderTop10(data);
                    renderGrid(data);
                    renderShorts(data);
                    updateUserContent();
                }
            } catch(e) { console.log("Offline mode or Error"); }
            finally {
                setTimeout(() => {
                    const s = document.getElementById('splash-screen');
                    s.style.opacity = '0';
                    setTimeout(() => s.style.visibility='hidden', 500);
                }, 1500);
            }
        };

        // --- 2. RENDER HERO & LISTS ---
        function renderHero(m) {
            const isLiked = checkList(m.id, 'f_likes');
            const isListed = checkList(m.id, 'f_list');
            
            document.getElementById('hero-container').innerHTML = `
                <div class="hero-wrap">
                    <img src="${m.img}" class="hero-bg">
                    <div class="hero-gradient"></div>
                    <div class="hero-content">
                        <div class="hero-tags">
                            <span class="tag" style="background:#fff; color:#000">TOP 1</span>
                            <span class="tag">HD</span>
                        </div>
                        <h1 class="hero-title">${m.title}</h1>
                        <p class="hero-desc">${m.desc}</p>
                        
                        <div class="hero-actions">
                            <div class="action-icon" onclick="toggleLike(${m.id}, this)">
                                <i class="fa-${isLiked?'solid':'regular'} fa-heart" style="color:${isLiked?'var(--primary)':'#fff'}"></i> Like
                            </div>
                            <div class="action-icon" onclick="toggleList(${m.id}, this)">
                                <i class="fa-${isListed?'solid':'regular'} fa-check-circle" style="color:${isListed?'#46d369':'#fff'}"></i> Lista
                            </div>
                            <div class="action-icon" onclick="downloadItem('${m.title}')">
                                <i class="fa-solid fa-download"></i> Descargar
                            </div>
                            <div class="action-icon" onclick="shareItem('${m.title}')">
                                <i class="fa-solid fa-share-nodes"></i> Compartir
                            </div>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-play" onclick="playVideo('${m.videoUrl}', ${m.id})"><i class="fa-solid fa-play"></i> Reproducir</button>
                            <button class="btn btn-glass" onclick="document.getElementById('sec-continue').scrollIntoView()"><i class="fa-solid fa-info-circle"></i> Info</button>
                        </div>
                    </div>
                </div>`;
        }

        function renderList(target, list) {
            document.getElementById(target).innerHTML = list.map(m => `
                <div class="card" onclick="playVideo('${m.videoUrl}', ${m.id})">
                    <img src="${m.img}" class="card-img" loading="lazy">
                </div>`).join('');
        }

        function renderTop10(list) {
            const top = list.slice(0, 10);
            document.getElementById('list-top10').innerHTML = top.map((m, i) => `
                <div class="rank-card" onclick="playVideo('${m.videoUrl}', ${m.id})">
                    <span class="rank-number">${i+1}</span>
                    <img src="${m.img}" class="rank-img">
                </div>`).join('');
        }

        // --- 3. SHORTS TIKTOK STYLE ---
        function renderShorts(list) {
            const feed = [...list, ...list];
            document.getElementById('shorts-feed').innerHTML = feed.map(m => `
                <div class="short-item">
                    <video src="${m.videoUrl}" class="short-video" loop playsinline onclick="this.paused?this.play():this.pause()"></video>
                    <div class="short-ui">
                        <div class="short-right">
                            <div class="s-action" onclick="toggleLike(${m.id})"><div class="s-icon-bg"><i class="fa-solid fa-heart"></i></div><span>Like</span></div>
                            <div class="s-action"><div class="s-icon-bg"><i class="fa-solid fa-comment-dots"></i></div><span>1.2k</span></div>
                            <div class="s-action" onclick="shareItem('${m.title}')"><div class="s-icon-bg"><i class="fa-solid fa-share"></i></div><span>Share</span></div>
                        </div>
                        <div class="short-bottom">
                            <h3>${m.title}</h3>
                            <p>${m.desc.substring(0,50)}...</p>
                        </div>
                    </div>
                </div>`).join('');
        }

        // --- 4. USER DATA (LIKES, LIST, HISTORY) ---
        function updateUserContent() {
            const hist = JSON.parse(localStorage.getItem('f_hist')) || {};
            const listIds = JSON.parse(localStorage.getItem('f_list')) || [];
            const likesIds = JSON.parse(localStorage.getItem('f_likes')) || [];

            // Stats
            document.getElementById('st-likes').innerText = likesIds.length;
            document.getElementById('st-list').innerText = listIds.length;

            // Continue Watching
            const histIds = Object.keys(hist).sort((a,b) => hist[b].ts - hist[a].ts);
            const cSec = document.getElementById('sec-continue');
            const cList = document.getElementById('list-continue');
            
            if(histIds.length === 0) cSec.classList.add('hidden');
            else {
                cSec.classList.remove('hidden');
                cList.innerHTML = histIds.map(id => {
                    const m = moviesDB.find(x => x.id == id);
                    if(!m) return '';
                    const h = hist[id];
                    const pct = h.dur ? (h.time/h.dur)*100 : 100;
                    return `
                    <div class="wide-card" onclick="playVideo('${m.videoUrl}', ${m.id})">
                        <div class="delete-btn" onclick="deleteHistory(event, ${id})"><i class="fa-solid fa-xmark"></i></div>
                        <div class="wide-img-box">
                            <img src="${m.img}" class="wide-img">
                            <div class="play-overlay"><i class="fa-solid fa-play" style="color:#fff"></i></div>
                            <div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div>
                        </div>
                        <div class="wide-info"><span>${m.title}</span><span>${Math.round(pct)}%</span></div>
                    </div>`;
                }).join('');
            }

            // My List
            const lSec = document.getElementById('sec-mylist');
            const lList = document.getElementById('list-mylist');
            if(listIds.length === 0) lSec.classList.add('hidden');
            else {
                lSec.classList.remove('hidden');
                const myList = moviesDB.filter(m => listIds.includes(m.id));
                lList.innerHTML = myList.map(m => `
                    <div class="card" onclick="playVideo('${m.videoUrl}', ${m.id})"><img src="${m.img}" class="card-img"></div>
                `).join('');
            }
        }

        function checkList(id, key) { return (JSON.parse(localStorage.getItem(key)) || []).includes(id); }
        function toggleList(id, el) { toggleStorage(id, 'f_list', 'Añadido a Lista', 'Eliminado de Lista'); updateUserContent(); }
        function toggleLike(id, el) { toggleStorage(id, 'f_likes', 'Te gusta esto', 'Ya no te gusta'); updateUserContent(); }

        function toggleStorage(id, key, msgAdd, msgRem) {
            let arr = JSON.parse(localStorage.getItem(key)) || [];
            if(arr.includes(id)) {
                arr = arr.filter(x => x !== id);
                showToast(msgRem, 'trash');
            } else {
                arr.push(id);
                showToast(msgAdd, 'check');
            }
            localStorage.setItem(key, JSON.stringify(arr));
        }

        function deleteHistory(e, id) {
            e.stopPropagation();
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            delete h[id];
            localStorage.setItem('f_hist', JSON.stringify(h));
            updateUserContent();
        }

        // --- 5. UTILS (DOWNLOAD, SHARE, TOAST) ---
        function showToast(msg, icon) {
            const box = document.createElement('div');
            box.className = 'toast';
            box.innerHTML = `
                <i class="fa-solid fa-${icon} toast-icon"></i>
                <div class="toast-body"><div class="toast-title">${msg}</div></div>`;
            document.getElementById('toast-container').appendChild(box);
            setTimeout(() => box.remove(), 3000);
        }

        function downloadItem(title) {
            const id = Date.now();
            const box = document.createElement('div');
            box.className = 'toast';
            box.innerHTML = `
                <i class="fa-solid fa-download toast-icon"></i>
                <div class="toast-body">
                    <div class="toast-title">Descargando ${title}...</div>
                    <div class="toast-bar-bg"><div class="toast-bar-fill" id="bar-${id}"></div></div>
                </div>`;
            document.getElementById('toast-container').appendChild(box);
            
            setTimeout(() => document.getElementById(`bar-${id}`).style.width = '100%', 100);
            setTimeout(() => { box.remove(); showToast('Descarga completada', 'check-double'); }, 2500);
        }

        function shareItem(title) {
            if(navigator.share) {
                navigator.share({ title: 'Flechazo TV', text: `Mira ${title} en Flechazo TV`, url: window.location.href });
            } else {
                showToast('Enlace copiado', 'copy');
            }
        }

        // --- 6. PERFIL EDITABLE ---
        function updateProfileUI() {
            const u = JSON.parse(localStorage.getItem('f_user')) || { name: 'Gamer Pro', pic: 'https://i.pinimg.com/736x/8b/16/7a/8b167af653c2399dd93b952a48740620.jpg' };
            document.getElementById('p-name').innerText = u.name;
            document.getElementById('p-avatar').src = u.pic;
        }
        function openEdit() { document.getElementById('edit-modal').style.display='flex'; }
        function closeEdit() { document.getElementById('edit-modal').style.display='none'; }
        function saveProfile() {
            const name = document.getElementById('edit-name').value;
            const pic = document.getElementById('edit-pic').value;
            if(name && pic) {
                localStorage.setItem('f_user', JSON.stringify({name, pic}));
                updateProfileUI();
                closeEdit();
                showToast('Perfil actualizado', 'user-check');
            }
        }

        // --- 7. PLAYER UNIVERSAL ---
        let currVid = null;
        function playVideo(url, id) {
            const w = document.getElementById('video-container');
            const o = document.getElementById('player-fs');
            const hist = JSON.parse(localStorage.getItem('f_hist')) || {};
            w.innerHTML = '';

            if(url.includes('youtu') || !url.match(/\.(mp4|webm|ogg)$/i)) {
                let src = url;
                if(url.includes('youtu')) {
                    const vid = url.includes('v=') ? url.split('v=')[1] : url.split('/').pop();
                    src = `https://www.youtube.com/embed/${vid}?autoplay=1&rel=0&modestbranding=1`;
                }
                w.innerHTML = `<iframe src="${src}" allowfullscreen allow="autoplay"></iframe>`;
                saveProg(id, 100, 100);
            } else {
                const v = document.createElement('video');
                v.src = url; v.controls = true; v.autoplay = true; v.playsInline = true;
                if(hist[id]) v.currentTime = hist[id].time;
                v.addEventListener('timeupdate', () => { if(v.currentTime>2) saveProg(id, v.currentTime, v.duration); });
                w.appendChild(v);
                currVid = v;
            }
            o.style.display = 'flex';
        }

        function saveProg(id, time, dur) {
            const h = JSON.parse(localStorage.getItem('f_hist')) || {};
            h[id] = { time, dur, ts: Date.now() };
            localStorage.setItem('f_hist', JSON.stringify(h));
        }

        function closePlayer() {
            if(currVid) currVid.pause();
            document.getElementById('video-container').innerHTML = '';
            document.getElementById('player-fs').style.display = 'none';
            updateUserContent();
        }

        // --- 8. NAVEGACIÓN & UTILS ---
        function goTab(tab, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(tab === 'profile') updateUserContent();
        }

        function runSearch() {
            const val = document.getElementById('search-inp').value.toLowerCase();
            const grid = document.getElementById('search-grid');
            const filtered = moviesDB.filter(m => m.title.toLowerCase().includes(val) || m.cat.toLowerCase().includes(val));
            grid.innerHTML = filtered.map(m => `<div onclick="playVideo('${m.videoUrl}',${m.id})"><img src="${m.img}" class="grid-img"></div>`).join('');
        }

        function renderGrid(list) { runSearch(); } // Init default
        function setTheme(c) { document.body.className = 'theme-'+c; localStorage.setItem('f_theme', c); }
        function resetApp() { if(confirm("¿Borrar todo?")) { localStorage.clear(); location.reload(); } }

    </script>
</body>
</html>
