<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Infinity Music - MASTER DJ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --primary: #00ffe5;
            --bg-main: #0a0a12;
            --bg-glass: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --nav-height: 75px;
        }
        * { box-sizing: border-box; outline: none; user-select: none; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-main); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: background 0.3s; }
        .hidden { display: none !important; }

        /* PÃGINAS */
        .page-container { flex: 1; position: relative; overflow: hidden; }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 20px 20px 120px 20px;
            opacity: 0; transform: translateY(20px); pointer-events: none; transition: 0.3s;
            display: none;
        }
        .page.active { opacity: 1; transform: translateY(0); pointer-events: all; display: block; }

        /* HOME */
        .greeting-box h2 { font-size: 26px; margin: 0; background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .resume-card { display: flex; align-items: center; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(0,0,0,0.2)); padding: 15px; border-radius: 15px; margin-top: 20px; cursor: pointer; border: 1px solid var(--bg-glass); display: none; }
        .resume-card img { width: 50px; height: 50px; border-radius: 10px; margin-right: 15px; object-fit: cover; }
        .horizontal-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-top: 15px; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        
        .card-recent { min-width: 130px; position: relative; display: flex; flex-direction: column; gap: 8px; cursor: pointer; }
        .card-recent img { width: 130px; height: 130px; border-radius: 15px; object-fit: cover; }
        .btn-add-mini { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: #fff; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.3); }

        /* BUSCADOR */
        .search-wrapper { position: sticky; top: 0; z-index: 10; background: var(--bg-main); padding-bottom: 10px; }
        #searchInput { width: 100%; padding: 15px 45px 15px 15px; border-radius: 15px; border: 1px solid var(--bg-glass); background: var(--bg-glass); color: #fff; font-size: 16px; }
        
        .list-item { display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; }
        .list-item img { width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; }
        .btn-queue-add { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: #fff; display: flex; align-items: center; justify-content: center; margin-left: auto; }
        .btn-queue-add:active { background: var(--primary); color: #000; }

        /* AI CHAT */
        .chat-box { height: calc(100% - 60px); overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 14px; }
        .msg.bot { background: rgba(255,255,255,0.1); align-self: flex-start; }
        .msg.user { background: var(--primary); color: #000; align-self: flex-end; }
        .ai-controls { display: flex; gap: 10px; height: 50px; }
        .ai-input { flex: 1; background: rgba(255,255,255,0.1); border: none; border-radius: 25px; padding: 0 20px; color: #fff; }
        .ai-btn { width: 50px; border-radius: 50%; border: none; background: var(--primary); cursor: pointer; color: #000; }

        /* FAVORITOS GRID */
        .fav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
        .fav-item { text-align: center; cursor: pointer; position: relative; }
        .fav-item img { width: 100%; aspect-ratio: 1; border-radius: 15px; object-fit: cover; margin-bottom: 5px; }

        /* FULL PLAYER & DJ UI */
        .full-player { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); z-index: 100; padding: 20px; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s; }
        .full-player.active { transform: translateY(0); }
        
        .viz-container { position: relative; width: 260px; height: 260px; margin: 10px auto; display: flex; justify-content: center; align-items: center; }
        .fp-art { width: 100%; height: 100%; border-radius: 50%; overflow: hidden; position: relative; z-index: 5; box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 3px solid #222; }
        .fp-art img { width: 100%; height: 100%; object-fit: cover; }
        .fp-art.rotating { animation: spin 8s linear infinite; }
        
        /* Spectrum Ring */
        .viz-ring { position: absolute; width: 110%; height: 110%; border-radius: 50%; border: 2px solid transparent; border-top-color: var(--primary); border-bottom-color: var(--primary); animation: spin 2s linear infinite; opacity: 0; transition: 0.3s; }
        .playing .viz-ring { opacity: 1; }

        /* DJ PAD */
        .dj-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-top: 15px; display: none; }
        .dj-pad.show { display: grid; animation: fadeInUp 0.3s; }
        .pad-btn { height: 50px; border: none; border-radius: 10px; font-weight: bold; font-size: 10px; color: #000; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 3px 0 rgba(0,0,0,0.5); }
        .pad-btn:active { transform: translateY(3px); box-shadow: none; }

        .main-controls { display: flex; justify-content: center; align-items: center; gap: 25px; margin-top: 20px; }
        .btn-circle { width: 70px; height: 70px; border-radius: 50%; background: var(--primary); border: none; font-size: 28px; box-shadow: 0 0 15px var(--primary); cursor: pointer; color: #000; display: flex; align-items: center; justify-content: center;}

        /* COLA MODAL */
        .queue-modal { position: fixed; bottom: 0; left: 0; width: 100%; height: 60%; background: #151522; border-radius: 30px 30px 0 0; z-index: 200; transform: translateY(100%); transition: 0.3s; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); border-top: 1px solid var(--primary); }
        .queue-modal.active { transform: translateY(0); }
        .queue-list { flex: 1; overflow-y: auto; margin-top: 15px; }
        .queue-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* NAVBAR & MINI PLAYER */
        .navbar { height: var(--nav-height); background: rgba(20,20,30,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); position: fixed; bottom: 0; width: 100%; z-index: 60; }
        .nav-link { display: flex; flex-direction: column; align-items: center; color: #666; font-size: 9px; width: 50px; }
        .nav-link.active { color: var(--primary); }
        .mini-player { position: fixed; bottom: 85px; left: 15px; right: 15px; height: 60px; background: rgba(30,30,50,0.95); backdrop-filter: blur(10px); border-radius: 12px; display: flex; align-items: center; padding: 0 10px; z-index: 50; border: 1px solid rgba(255,255,255,0.1); transform: translateY(150%); transition: 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .mini-player.visible { transform: translateY(0); }
        .mp-img { width: 40px; height: 40px; border-radius: 8px; margin-right: 10px; animation: spin 8s linear infinite paused; }
        .mp-img.playing { animation-play-state: running; }

        /* TOAST */
        #toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 12px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300; }
        #toast.show { opacity: 1; top: 50px; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeInUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>
    <div id="toast">NotificaciÃ³n</div>

    <div class="page-container">
        <div id="tab-home" class="page active">
            <div class="greeting-box"><h2 id="greeting">Hola ð</h2><p style="color:#aaa;">Tu mÃºsica te espera.</p></div>
            <div id="resume-card" class="resume-card" onclick="resumeLast()">
                <img id="res-img" src="">
                <div><h4 id="res-title" style="margin:0; font-size:14px;">Continuar...</h4><p style="margin:0; font-size:11px; color:var(--primary);">Ãltima reproducciÃ³n</p></div>
            </div>
            <h4 style="margin-top: 30px; color: var(--primary); font-size: 12px; letter-spacing: 1px;">HISTORIAL</h4>
            <div class="horizontal-scroll" id="home-history"></div>
        </div>

        <div id="tab-search" class="page">
            <div class="search-wrapper"><input type="text" id="searchInput" placeholder="Buscar..."><i class="fas fa-search" style="position:absolute; right:15px; top:15px; color:#aaa;"></i></div>
            <div id="results"><div style="text-align:center; padding:50px; color:#555;"><i class="fas fa-music" style="font-size:40px;"></i><p>Busca mÃºsica</p></div></div>
        </div>

        <div id="tab-ai" class="page">
            <h2 style="margin-bottom:15px;">AI DJ</h2>
            <div class="chat-box" id="chat-box"><div class="msg bot">Escribe <b>"Pon [canciÃ³n]"</b>.</div></div>
            <div class="ai-controls"><input type="text" id="ai-input" class="ai-input" placeholder="Ej: Pon Feid..." onkeypress="if(event.key==='Enter') sendAi()"><button class="ai-btn" onclick="sendAi()"><i class="fas fa-paper-plane"></i></button></div>
        </div>

        <div id="tab-fav" class="page"><h2>Favoritos</h2><div class="fav-grid" id="fav-list" style="margin-top:15px;"></div></div>

        <div id="tab-settings" class="page">
            <h2>Ajustes</h2>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin:20px 0;">
                <h4>Temas</h4>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <div style="width:30px;height:30px;border-radius:50%;background:#00ffe5;" onclick="setTheme('#00ffe5')"></div>
                    <div style="width:30px;height:30px;border-radius:50%;background:#ff0055;" onclick="setTheme('#ff0055')"></div>
                    <div style="width:30px;height:30px;border-radius:50%;background:#e5ff00;" onclick="setTheme('#e5ff00')"></div>
                </div>
            </div>
            <button onclick="clearData()" style="width:100%; padding:15px; background:rgba(255,0,0,0.2); color:#ff5555; border:none; border-radius:10px;">Borrar Datos</button>
        </div>
    </div>

    <div id="mini-player" class="mini-player" onclick="openFullPlayer()">
        <img src="" id="mp-img" class="mp-img">
        <div style="flex:1; overflow:hidden;"><h4 id="mp-title" style="margin:0; font-size:14px; white-space:nowrap;">Cargando...</h4><p id="mp-artist" style="margin:0; font-size:12px; color:var(--primary);">...</p></div>
        <button onclick="togglePlay(event)" style="background:none; border:none; color:#fff; font-size:22px; padding:10px;"><i id="mp-play-icon" class="fas fa-play"></i></button>
    </div>

    <div id="full-player" class="full-player">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <i class="fas fa-chevron-down" onclick="closeFullPlayer()" style="font-size: 24px; padding: 10px;"></i>
            <div style="text-align:center;">
                <span style="font-size: 10px; letter-spacing: 2px; color: #aaa;">CONSOLA</span>
                <div style="margin-top:5px; display:flex; gap:10px;">
                    <button onclick="toggleDjPad()" style="background:transparent; border:1px solid var(--primary); color:var(--primary); padding:3px 10px; border-radius:15px; font-size:10px;">DJ PAD</button>
                    <button onclick="toggleQueue()" style="background:transparent; border:1px solid #aaa; color:#fff; padding:3px 10px; border-radius:15px; font-size:10px;">COLA</button>
                </div>
            </div>
            <i id="fp-heart" class="far fa-heart" onclick="toggleLike()" style="font-size: 24px; padding: 10px;"></i>
        </div>
        
        <div class="viz-container">
            <div class="viz-ring"></div>
            <div class="fp-art"><img src="" id="fp-img"></div>
        </div>

        <h2 id="fp-title" style="text-align:center; margin:10px 0 0; white-space:nowrap; overflow:hidden;">TÃ­tulo</h2>
        <p id="fp-artist" style="text-align:center; color:var(--primary); margin:5px 0 0;">Artista</p>

        <div id="dj-pad" class="dj-pad">
            <button class="pad-btn" style="background:#ffcc00;" onmousedown="playSfx('horn')">ð¢ HORN</button>
            <button class="pad-btn" style="background:#ff0055; color:#fff;" onmousedown="playSfx('laser')">ð« LAZER</button>
            <button class="pad-btn" style="background:#00ffe5;" onmousedown="playSfx('scratch')">ð¿ SCRATCH</button>
            <button class="pad-btn" id="btn-autodj" style="background:#333; color:#fff;" onclick="toggleAutoDj()">ð¤ AUTO</button>
            <button class="pad-btn" style="background:#fff;" onclick="changeSpeed()">â¡ SPEED</button>
            <button class="pad-btn" style="background:#666; color:#fff;" onclick="downloadSong()">â¬ï¸ BAJAR</button>
        </div>
        
        <div style="margin-top: 20px;">
            <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:10px;" id="prog-bar">
                <div id="prog-fill" style="width:0%; height:100%; background:var(--primary); border-radius:10px;"></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-top:8px;">
                <span id="curr-time">0:00</span>
                <span id="dur-time">0:00</span>
            </div>
        </div>

        <div class="main-controls">
            <button onclick="playPrev()" style="background:none; border:none; color:#fff; font-size:24px;"><i class="fas fa-backward"></i></button>
            <button class="btn-circle" onclick="togglePlay()"><i id="fp-play-icon" class="fas fa-play"></i></button>
            <button onclick="playNextManual()" style="background:none; border:none; color:#fff; font-size:24px;"><i class="fas fa-forward"></i></button>
        </div>
    </div>

    <div id="queue-modal" class="queue-modal">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>Cola</h3><i class="fas fa-times" onclick="toggleQueue()"></i></div>
        <div id="queue-list" class="queue-list"></div>
        <button onclick="clearQueue()" style="width:100%; padding:10px; margin-top:10px; background:rgba(255,0,0,0.2); color:#ff5555; border:none; border-radius:10px;">Limpiar</button>
    </div>

    <nav class="navbar">
        <div class="nav-link active" onclick="switchTab('home')"><i class="fas fa-home"></i>Inicio</div>
        <div class="nav-link" onclick="switchTab('search')"><i class="fas fa-search"></i>Buscar</div>
        <div class="nav-link" onclick="switchTab('ai')"><i class="fas fa-robot"></i>AI DJ</div>
        <div class="nav-link" onclick="switchTab('fav')"><i class="fas fa-heart"></i>Favs</div>
        <div class="nav-link" onclick="switchTab('settings')"><i class="fas fa-cog"></i>Ajustes</div>
    </nav>

    <audio id="audio"></audio>

    <script>
        // --- CONFIG & APIS ---
        const searchInput = document.getElementById('searchInput');
        const results = document.getElementById('results');
        const audio = document.getElementById('audio');
        const audioApis = [
          { name: 'HexaGate', func: url => `https://hexagate.darkcore.xyz/api/ytmp3?url=${encodeURIComponent(url)}` },
          { name: 'DarkCoreAPI', func: url => `https://dark-core-api.vercel.app/api/download/ytmp3?key=Darkito&url=${encodeURIComponent(url)}` },
          { name: 'Siputzx', func: url => `https://api.siputzx.my.id/api/d/ytmp3?url=${encodeURIComponent(url)}` }
        ];

        let debounceTimeout, currentTrack = null, sleepTimer = null;
        let favorites = JSON.parse(localStorage.getItem('inf_favs')) || [];
        let history = JSON.parse(localStorage.getItem('inf_hist')) || [];
        let lastPlayed = JSON.parse(localStorage.getItem('inf_last')) || null;
        
        // --- VARS DJ & COLA ---
        let queue = [];
        let autoDj = false;
        let speedRate = 1.0;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();

        window.onload = () => {
            const h = new Date().getHours();
            document.getElementById('greeting').innerText = h<12?"Buenos dÃ­as":h<19?"Buenas tardes":"Buenas noches";
            if(localStorage.getItem('inf_theme')) document.documentElement.style.setProperty('--primary', localStorage.getItem('inf_theme'));
            renderData();
            if(lastPlayed) {
                document.getElementById('resume-card').style.display = 'flex';
                document.getElementById('res-img').src = lastPlayed.img;
                document.getElementById('res-title').innerText = lastPlayed.title;
            }
        };

        // --- BUSCADOR ---
        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => { performSearch(searchInput.value.trim()); }, 500);
        });

        async function performSearch(query) {
            if (query.length <= 2) { results.innerHTML=''; return; }
            results.innerHTML = `<div style="text-align:center; padding: 30px;"><i class="fas fa-circle-notch fa-spin" style="font-size: 24px; color: var(--primary);"></i><p style="margin-top:10px;">Buscando...</p></div>`;
            try {
                const res = await fetch(`https://night-api-seven.vercel.app/api/search/youtube?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data.status && data.result) {
                    results.innerHTML = '';
                    data.result.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `
                            <img src="${item.miniatura}" onclick="playAudio('${item.titulo.replace(/'/g,"\\'")}','${item.url}','${item.miniatura}','${item.author}')">
                            <div style="flex:1" onclick="playAudio('${item.titulo.replace(/'/g,"\\'")}','${item.url}','${item.miniatura}','${item.author}')">
                                <h4 style="margin:0; font-size:14px;">${item.titulo}</h4><p style="margin:0; font-size:11px; color:#aaa;">${item.author || ''}</p>
                            </div>
                            <button class="btn-queue-add" onclick="addToQueue('${item.titulo.replace(/'/g,"\\'")}','${item.url}','${item.miniatura}','${item.author}')"><i class="fas fa-plus"></i></button>
                        `;
                        results.appendChild(div);
                    });
                } else results.innerHTML = '<p style="text-align:center">Sin resultados.</p>';
            } catch (e) { results.innerHTML = '<p style="text-align:center">Error de conexiÃ³n.</p>'; }
        }

        // --- REPRODUCCIÃN ---
        async function playAudio(title, videoUrl, thumbnail, author) {
            // Activar AudioContext para SFX
            if(ctx.state === 'suspended') ctx.resume();

            currentTrack = { title, url: videoUrl, img: thumbnail, author };
            ['mp','fp'].forEach(p => {
                document.getElementById(`${p}-title`).innerText = title;
                document.getElementById(`${p}-artist`).innerText = "Cargando audio...";
                document.getElementById(`${p}-img`).src = thumbnail;
            });
            document.getElementById('mini-player').classList.add('visible');
            openFullPlayer();
            updatePlayUI(false); 

            let finalUrl = null;
            for (const api of audioApis) {
                try {
                    document.getElementById('fp-artist').innerText = `Probando: ${api.name}...`;
                    const res = await fetch(api.func(videoUrl));
                    const data = await res.json();
                    if (data.result?.download) finalUrl = data.result.download;
                    else if (data.result?.url) finalUrl = data.result.url;
                    else if (data.url) finalUrl = data.url;
                    else if (data.download) finalUrl = data.download;
                    if (finalUrl) break;
                } catch (e) {}
            }

            if (finalUrl) {
                audio.src = finalUrl;
                audio.volume = 1; // Reset volumen si hubo fade out
                audio.play();
                updatePlayUI(true);
                const artistTxt = author || "Reproduciendo";
                document.getElementById('mp-artist').innerText = artistTxt;
                document.getElementById('fp-artist').innerText = artistTxt;
                addToHistory(currentTrack);
                localStorage.setItem('inf_last', JSON.stringify(currentTrack));
                updateLikeIcon();
            } else {
                showToast("Error al reproducir. Intentando siguiente...");
                playNext(); 
            }
        }

        // --- COLA & DJ LOGIC ---
        function addToQueue(title, url, img, author) {
            queue.push({title, url, img, author});
            showToast("AÃ±adido a la cola");
            renderQueue();
        }

        function playNext() {
            if(queue.length > 0) {
                const next = queue.shift();
                playAudio(next.title, next.url, next.img, next.author);
                renderQueue();
            } else if (autoDj && (history.length > 0 || favorites.length > 0)) {
                // Auto DJ Random
                const source = favorites.length > 0 ? favorites : history;
                const r = source[Math.floor(Math.random() * source.length)];
                playAudio(r.title, r.url, r.img, r.author);
                showToast("DJ Mix: " + r.title);
            } else {
                audio.pause(); updatePlayUI(false);
            }
        }
        
        function playNextManual() { playNext(); }
        function playPrev() { audio.currentTime = 0; }

        function renderQueue() {
            const list = document.getElementById('queue-list'); list.innerHTML = '';
            if(queue.length === 0) list.innerHTML = '<p style="text-align:center; color:#555; margin-top:20px;">Cola vacÃ­a</p>';
            queue.forEach((item, index) => {
                list.innerHTML += `<div class="queue-item"><img src="${item.img}" style="width:40px; border-radius:5px; margin-right:10px;"><div style="flex:1; font-size:12px;">${item.title}</div><i class="fas fa-trash" style="color:#666;" onclick="removeFromQueue(${index})"></i></div>`;
            });
        }
        function removeFromQueue(i) { queue.splice(i, 1); renderQueue(); }
        function clearQueue() { queue = []; renderQueue(); toggleQueue(); }
        function toggleQueue() { document.getElementById('queue-modal').classList.toggle('active'); }

        // --- DJ FX ---
        function playSfx(type) {
            if(ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            const t = ctx.currentTime;
            
            if(type==='horn') {
                osc.type='sawtooth'; osc.frequency.setValueAtTime(300,t); osc.frequency.linearRampToValueAtTime(500,t+0.1);
                gain.gain.setValueAtTime(0.5,t); gain.gain.linearRampToValueAtTime(0,t+0.4);
                osc.start(t); osc.stop(t+0.4);
            } else if(type==='laser') {
                osc.type='square'; osc.frequency.setValueAtTime(800,t); osc.frequency.exponentialRampToValueAtTime(100,t+0.2);
                gain.gain.setValueAtTime(0.3,t); gain.gain.exponentialRampToValueAtTime(0,t+0.2);
                osc.start(t); osc.stop(t+0.2);
            } else if(type==='scratch') {
                osc.type='triangle'; osc.frequency.setValueAtTime(200,t); osc.frequency.linearRampToValueAtTime(800,t+0.1);
                gain.gain.setValueAtTime(0.5,t); gain.gain.linearRampToValueAtTime(0,t+0.1);
                osc.start(t); osc.stop(t+0.1);
            }
        }

        function toggleDjPad() { document.getElementById('dj-pad').classList.toggle('show'); }
        function toggleAutoDj() { 
            autoDj = !autoDj; 
            document.getElementById('btn-autodj').style.background = autoDj ? 'var(--primary)' : '#333';
            showToast(autoDj ? "Auto DJ: ON" : "Auto DJ: OFF");
        }
        function changeSpeed() {
            speedRate = speedRate === 1.0 ? 1.25 : speedRate === 1.25 ? 1.5 : 1.0;
            audio.playbackRate = speedRate;
            showToast("Velocidad: " + speedRate + "x");
        }

        // --- EVENTS ---
        audio.addEventListener('ended', () => { if(!audio.loop) playNext(); });
        
        audio.addEventListener('timeupdate', () => {
            if(audio.duration) {
                const pct = (audio.currentTime/audio.duration)*100;
                document.getElementById('prog-fill').style.width = pct + '%';
                const f = t => {const m=Math.floor(t/60),s=Math.floor(t%60); return m+':'+(s<10?'0':'')+s;};
                document.getElementById('curr-time').innerText = f(audio.currentTime);
                document.getElementById('dur-time').innerText = f(audio.duration);
                // DJ Crossfade
                if(autoDj && audio.duration - audio.currentTime < 5 && audio.volume > 0.1) audio.volume -= 0.05;
            }
        });

        // --- EXTRAS ---
        function resumeLast() { if(lastPlayed) playAudio(lastPlayed.title, lastPlayed.url, lastPlayed.img, lastPlayed.author); }
        function downloadSong() { if(audio.src) { window.open(audio.src, '_blank'); showToast("Descargando..."); } }
        function setTheme(c) { document.documentElement.style.setProperty('--primary', c); localStorage.setItem('inf_theme', c); }
        function clearData() { if(confirm("Â¿Borrar todo?")) { localStorage.clear(); location.reload(); } }
        
        function switchTab(id) {
            document.querySelectorAll('.page').forEach(p => { p.classList.remove('active'); p.style.display='none'; });
            const pg = document.getElementById('tab-'+id); pg.style.display='block'; setTimeout(()=>pg.classList.add('active'),10);
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            const idx = ['home','search','ai','fav','settings'].indexOf(id);
            document.querySelectorAll('.nav-link')[idx].classList.add('active');
            if(id==='home'||id==='fav') renderData();
        }

        function togglePlay(e) { if(e)e.stopPropagation(); audio.paused?audio.play():audio.pause(); updatePlayUI(!audio.paused); }
        function updatePlayUI(play) {
            const i = play?'fa-pause':'fa-play';
            document.getElementById('mp-play-icon').className = `fas ${i}`;
            document.getElementById('fp-play-icon').className = `fas ${i}`;
            const viz = document.querySelector('.viz-ring');
            play ? viz.classList.add('playing') : viz.classList.remove('playing');
            play ? document.querySelector('.fp-art').classList.add('rotating') : document.querySelector('.fp-art').classList.remove('rotating');
            play ? document.getElementById('mp-img').classList.add('playing') : document.getElementById('mp-img').classList.remove('playing');
        }

        function openFullPlayer() { document.getElementById('full-player').classList.add('active'); }
        function closeFullPlayer() { document.getElementById('full-player').classList.remove('active'); }
        function toggleLike() { if(!currentTrack)return; const idx = favorites.findIndex(f=>f.url===currentTrack.url); idx===-1?favorites.push(currentTrack):favorites.splice(idx,1); localStorage.setItem('inf_favs', JSON.stringify(favorites)); updateLikeIcon(); showToast(idx===-1?"AÃ±adido":"Eliminado"); }
        function updateLikeIcon() { const isFav = currentTrack && favorites.some(f=>f.url===currentTrack.url); document.getElementById('fp-heart').className = isFav?'fas fa-heart':'far fa-heart'; document.getElementById('fp-heart').style.color = isFav?'var(--primary)':'#fff'; }
        
        function addToHistory(t) {
            history = history.filter(h=>h.url!==t.url); history.unshift(t);
            if(history.length>10) history.pop();
            localStorage.setItem('inf_hist', JSON.stringify(history));
        }

        function renderData() {
            const hL = document.getElementById('home-history'); hL.innerHTML='';
            history.forEach(h => hL.innerHTML+=`<div class="card-recent"><img src="${h.img}" onclick="playAudio('${h.title.replace(/'/g,"\\'")}','${h.url}','${h.img}','${h.author}')"><h4>${h.title}</h4><button class="btn-add-mini" onclick="addToQueue('${h.title.replace(/'/g,"\\'")}','${h.url}','${h.img}','${h.author}')">+</button></div>`);
            const fL = document.getElementById('fav-list'); fL.innerHTML='';
            favorites.forEach(f => fL.innerHTML+=`<div class="fav-item"><img src="${f.img}" onclick="playAudio('${f.title.replace(/'/g,"\\'")}','${f.url}','${f.img}','${f.author}')"><button class="btn-add-mini" style="margin:5px auto; position:relative; right:auto; top:auto;" onclick="addToQueue('${f.title.replace(/'/g,"\\'")}','${f.url}','${f.img}','${f.author}')">+</button></div>`);
        }

        // --- AI ---
        async function sendAi() {
            const inp = document.getElementById('ai-input'); const txt = inp.value.trim();
            if(!txt) return;
            document.getElementById('chat-box').innerHTML += `<div class="msg user">${txt}</div>`;
            inp.value = '';
            if(txt.toLowerCase().startsWith('pon ')) {
                const s = txt.replace(/pon /i, '');
                try {
                    const res = await fetch(`https://night-api-seven.vercel.app/api/search/youtube?q=${encodeURIComponent(s)}`);
                    const d = await res.json();
                    if(d.status && d.result.length>0) {
                        playAudio(d.result[0].titulo, d.result[0].url, d.result[0].miniatura, d.result[0].author);
                        document.getElementById('chat-box').innerHTML += `<div class="msg bot">Reproduciendo ${d.result[0].titulo}</div>`;
                    }
                } catch(e){}
            }
        }

        function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
        document.getElementById('prog-bar').addEventListener('click', e => { audio.currentTime = (e.offsetX / document.getElementById('prog-bar').clientWidth) * audio.duration; });
    </script>
</body>
</html>
